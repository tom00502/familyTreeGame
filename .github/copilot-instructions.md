# 家族族譜連連看 - 產品規格書

## 不要處理ts錯誤 我現在不想處理型別問題，專注在產品規格書的內容上。謝謝！

## 不要處理ts錯誤 我現在不想處理型別問題，專注在產品規格書的內容上。謝謝！

## 不要處理ts錯誤 我現在不想處理型別問題，專注在產品規格書的內容上。謝謝！

## 📋 產品概述

**家族族譜連連看 (Family Tree Connect)** 是一款專為親戚聚會設計的實時多人協作遊戲。玩家透過回答彼此的親屬關係、填寫家族成員資訊，在限定時間內共同拼湊出完整的家族族譜。遊戲強調真實性、協作性與趣味性，讓家族成員在遊戲過程中重新認識彼此的血緣關係。

### 核心價值

- **真實連結**：所有玩家為真實親戚，資料具備真實性與情感價值
- **協作競速**：全體玩家共同完成族譜，但依個人貢獻度計分
- **漸進揭曉**：遊戲過程中不顯示族譜全貌，結束時才進行「大揭曉」
- **社交樂趣**：透過問答互動，喚起家族記憶與共同話題

---

## 📚 文件導航 (docs/ 資料夾)

本規格書在 `docs/` 資料夾下，按**資料夾分類**組織，供不同角色查閱。新進人員請根據自身角色選擇對應資料夾開始閱讀。

### 文件結構概覽

```
docs/ (規格文件根目錄)
├── concepts/ (核心概念層)
│   └─ mvft.md (最小可行族譜)
│
├── management/ (管理層)
│   └─ room_management.md (房間管理、玩家狀態、WebSocket 通訊)
│
├── features/ (業務策略層)
│   ├─ qa_phase1_relationship_check.md (關係確認出題邏輯)
│   ├─ qa_phase2_data_filling.md (資料填充策略)
│   ├─ qa_phase3_data_check.md (計分與結果呈現)
│   └─ spectator_mode.md (旁觀者看板、答題監測、即時族譜)
│
├── technical/ (技術實作層)
│   ├─ dag_traversal.md (DAG 遍歷演算法)
│   ├─ concurrency_lock.md (併發控制與鎖定機制)
│   └─ conflict_resolution.md (衝突偵測與解決)
│
└── design/ (視覺規範層)
    ├─ visual_system.md (配色、排版、圖示規範)
    ├─ animation_specs.md (動畫效果、轉場、揭曉效果)
    └─ spouse_merge_guide.md (配偶合併、性別顯示規範)
```

### 按角色選擇閱讀資料夾

| 角色              | 必讀                   | 推薦                 | 參考                                |
| ----------------- | ---------------------- | -------------------- | ----------------------------------- |
| **新進人員/PM**   | concepts/、features/   | management/、design/ | technical/                          |
| **後端工程師**    | concepts/、management/ | technical/           | design/、features/                  |
| **演算法/資料庫** | concepts/、technical/  | management/          | features/、design/                  |
| **前端工程師**    | concepts/、design/     | features/ (計分呈現) | management/ (WebSocket)、technical/ |
| **UI/UX 設計師**  | concepts/、design/     | features/ (UX 流程)  | management/、technical/             |
| **遊戲設計師**    | concepts/、features/   | management/、design/ | technical/                          |

### 資料夾說明

#### 📁 concepts/ (核心概念層)

**用途**：定義貫穿整個系統的基礎術語與概念  
**特點**：被所有其他文檔引用，新進人員必讀  
**主要檔案**：

- [mvft.md](../docs/concepts/mvft.md) - 最小可行族譜定義、關鍵路徑、核心家庭單元、任務優先級

**適合讀者**：所有人（建議首先閱讀）

#### 📁 management/ (管理層)

**用途**：處理遊戲「開始前」與「結束後」的基礎建設  
**特點**：與族譜演算法無關，專注於伺服器連線、房間狀態、即時通訊  
**主要檔案**：

- [room_management.md](../docs/management/room_management.md) - 房間生命週期、玩家狀態、WebSocket 心跳、自動重連、特殊情況處理

**適合讀者**：後端工程師、DevOps、系統架構師

#### 📁 features/ (業務策略層)

**用途**：實現遊戲玩法的「策略層」，不談程式碼實作，只談邏輯設計  
**核心問題**：

- 系統要問什麼？
- 什麼時候切換階段？
- 分數怎麼算？
- 資料怎麼驗證？

**主要檔案**：

- [qa_phase1_relationship_check.md](../docs/features/qa_phase1_relationship_check.md) - 關係確認階段的出題邏輯、二階段追問、虛擬節點生成
- [qa_phase2_data_filling.md](../docs/features/qa_phase2_data_filling.md) - 資料填充階段的任務派發策略、MVFT 概念、獨佔提問規則
- [qa_phase3_data_check.md](../docs/features/qa_phase3_data_check.md) - 結算階段的資料驗證、衝突解決、計分系統、排名機制
- [spectator_mode.md](../docs/features/spectator_mode.md) - 旁觀者看板、答題監測、即時族譜、權限限制

**適合讀者**：產品經理、遊戲設計師、業務分析師、前端（特別是 UX 流程部分）

#### 📁 technical/ (技術實作層)

**用途**：「冷冰冰的技術」，提供實作細節給工程師  
**核心問題**：

- DAG 怎麼遍歷？
- 如何處理併發衝突？
- 效能瓶頸在哪？
- 如何最佳化查詢？

**主要檔案**：

- dag_traversal.md - 有向無環圖遞歸、BFS/DFS 策略、路徑查詢
- concurrency_lock.md - 併發鎖實作、樂觀/悲觀鎖選擇、事務隔離
- conflict_resolution.md - 衝突偵測演算法、優先級規則、自動合併策略

**適合讀者**：演算法工程師、後端核心開發、資料庫優化工程師

#### 📁 design/ (視覺規範層)

**用途**：統一視覺語言，確保設計與前端的一致性  
**核心內容**：

- 配色、排版、圖示規範
- 動畫效果與轉場邏輯
- 配偶合併、性別顯示規範
- 響應式設計斷點
- 可及性檢查清單

**主要檔案**：

- visual_system.md - 配色方案、字體、組件設計、間距規則
- animation_specs.md - 大揭曉動畫、轉場效果、載入狀態視覺反饋
- spouse_merge_guide.md - 配偶節點合併視覺表現、性別顯示、關係線繪製

**適合讀者**：UI/UX 設計師、前端工程師

---

## 🎮 遊戲機制

### 基本規則

1. **玩家身份**：所有玩家必須是真實親屬關係
2. **遊戲時長**：可選 90 秒、120 秒或 180 秒
3. **最少人數**：至少 2 位玩家才能開始遊戲
4. **實時協作**：所有玩家同時進行，但不會即時看到他人的進度，只有系統知道每位玩家的填寫狀況
5. **資訊隱蔽**：遊戲進行時不顯示族譜結構，僅在結束時揭曉

### 遊戲流程

#### 階段 0：房間建立與加入

玩家在進入遊戲世界前，需先建立或加入一個房間。房間管理涵蓋房間建立、玩家加入、狀態管理等主要功能。

📄 **詳細規格** → [room_management.md](../docs/management/room_management.md)

此階段涵蓋：

- 房主建立房間與配置遊戲時長
- 玩家資料設定（姓名、性別、出生日期）
- 多種加入方式（分享連結、房間代碼）
- 等待大廳的實時功能（玩家列表、分享邀請、啟動遊戲）

### 📝 提問與結果發表過程

玩家在遊戲進行中不會看到階段轉變提示，系統根據**出題邏輯**自動推進三個連續的提問階段，最終在時間結束時進行**大揭曉**。

#### 階段 1：關係確認 (Relationship Check)

**玩家體驗**：持續回答「其他玩家是你的誰」的二階段問題

**系統目標**：確立玩家之間的親屬關係，建立族譜骨架

📄 **詳細規格** → [qa_phase1_relationship_check.md](../docs/features/qa_phase1_relationship_check.md)

此階段涵蓋：

- 二階段追問機制（方向選擇 → 具體稱謂）
- 性別過濾與稱謂範圍（四等親內）
- 「完全不知道」與「不知道」的處理流程
- 虛擬節點自動生成邏輯
- 出題派發算法（玩家數量 < 4 與 ≥ 4 的差異）

#### 階段 2：資料填充 (Data Completion)

**玩家體驗**：持續回答「虛擬節點資訊」的各種題目（姓名、性別、生日、親屬確認等）

**系統目標**：填補虛擬節點的詳細資訊，完成最小可行族譜 (MVFT)

📄 **詳細規格** → [qa_phase2_data_filling.md](../docs/features/qa_phase2_data_filling.md)

此階段涵蓋：

- 最小可行族譜 (MVFT) 的核心概念與完成標準
- 五類任務類型（節點命名、屬性填充、向上追溯、節點匯聚、排序確認）
- 任務派發策略與優先級分級
- 稱謂與路徑對應表 (Kinship Mapping)
- 獨佔提問規則與鎖定機制
- 邊界情況處理（多重婚姻、同名誤判、衝突標記）

#### 階段 3：資料確認與大揭曉 (Data Verification & Big Reveal)

**玩家體驗**：遊戲時間結束，系統驗證資料、解決衝突，展示完整族譜及排名

**系統目標**：驗證、確認和展示最終的族譜結果

📄 **詳細規格** → [qa_phase3_data_check.md](../docs/features/qa_phase3_data_check.md)

此階段涵蓋：

- 資料核查流程（衝突檢測、完整性驗證、關係一致性檢查）
- 揭曉動畫與視覺化呈現
- 計分系統詳解（計分項目、權重、排名機制）
- 結果呈現（族譜完整度、個人貢獻、MVP 決定）
- 特殊情況與異常處理

---

## 🏗️ 系統功能規格

### 房間與玩家管理

房間管理是遊戲的基礎設施，涵蓋房間建立、玩家加入、狀態管理、通訊同步等功能。詳見 [room_management.md](../docs/management/room_management.md)

此章節涵蓋：

- 房間生命週期與狀態機（未啟動 → 等待中 → 進行中 → 結算中）
- 房主角色與権限（配置遊戲、啟動遊戲、房主轉移）
- 玩家身份識別與狀態管理（playerId、連線狀態、旁觀者模式）
- WebSocket 即時通訊、心跳檢測、自動重連機制
- 特殊情況處理（斷線重連、房主離線轉移、旁觀者進入）

### 族譜系統

**節點類型**：

- **真實玩家節點**：實際參與遊戲的玩家
- **虛擬節點**：根據關係推導出的家族成員

**族譜結構**：

- 有向無環圖 (DAG) 結構
- 支援多代追溯（依 MVFT 原則限制深度）
- 自動節點去重與匯聚

詳細的節點屬性、關係類型、資料結構定義見 [room_management.md](../docs/management/room_management.md) 中的**資料結構規格**部分。

### 出題系統

遊戲根據玩家人數與虛擬節點狀態自動派發題目，分三個階段的出題邏輯與策略詳見以下規格文件：

**第一階段（關係確認）** → [qa_phase1_relationship_check.md](../docs/features/qa_phase1_relationship_check.md#-出題派發規則)  
**第二階段（資料填充）** → [qa_phase2_data_filling.md](../docs/features/qa_phase2_data_filling.md#-任務派發策略)  
**第三階段（資料確認）** → [qa_phase3_data_check.md](../docs/features/qa_phase3_data_check.md)

問題模板詳見各階段規格文件中的**提問問題模板表**部分。

### 旁觀系統

旁觀系統可以觀察遊戲過程但不參與遊戲，詳見 [spectator_mode.md](../docs/features/spectator_mode.md)

此章節涵蓋：

- 旁觀者看板（答題監測區塊 + 即時族譜區塊）
- 答題歷史紀錄與玩家狀態列表
- 即時族譜節點更新機制與動畫
- 旁觀者權限限制與 WebSocket 事件同步

### 計分系統

計分系統的完整說明（計分項目、權重、修飾符、排名機制、MVP 決定）詳見 [qa_phase3_data_check.md](../docs/features/qa_phase3_data_check.md#-計分系統詳解)

### 即時通訊

即時通訊負責房間內各玩家的狀態同步、題目派發、計分更新等實時功能。詳見 [room_management.md](../docs/management/room_management.md#-即時通訊與同步) 的**即時通訊與同步**章節，涵蓋：

- WebSocket 連線管理、自動重連機制、心跳檢測
- 訊息類型與格式（房間管理、玩家狀態、遊戲事件）
- 狀態同步規則與延遲標準

---

## 📊 資料結構規格

### 房間與玩家資料結構

房間與玩家相關的資料結構（Room、Player、FamilyNode）詳見 [room_management.md](../docs/management/room_management.md#-資料結構規格)

### 族譜節點資料結構

```
族譜節點 (FamilyNode)
├── id: 唯一識別碼
├── name: 姓名
├── gender: 性別
├── birthday: 出生日期（選填）
├── isVirtual: 是否為虛擬節點
├── isPlayer: 是否為玩家節點
├── playerId: 對應的玩家 ID（若為玩家節點）
├── isOnKeyPath: 是否在關鍵路徑上
├── expansionType: 擴張類型（FULL/TERMINAL）
├── father: 父親節點 ID
├── mother: 母親節點 ID
├── spouse: 配偶節點 ID
└── children: 子女節點 ID 列表
```

---

## 🎯 使用者體驗設計

### 視覺風格

**配色方案**：

- 主色：`#8B2635`（深紅色）- 象徵家族傳承
- 輔色：`#D4AF37`（金色）- 象徵榮耀與成就
- 背景：`#FAF8F3`（米白色）- 溫暖舒適
- 文字：`#5C2E2E`（深棕色）- 易讀穩重
- 次要：`#8B8278`（灰棕色）- 低調輔助

**設計元素**：

- 圓角設計（溫馨親和）
- 柔和漸層（視覺舒適）
- 大型圖示與表情符號（易理解）
- 清晰的按鈕狀態（操作反饋）

### 互動設計

**回應式設計**：

- 支援桌面與行動裝置
- 適應不同螢幕尺寸
- 觸控友善的按鈕大小

**即時反饋**：

- Loading 動畫（等待提示）
- 輸入驗證即時提示
- 操作成功/失敗提示
- 進度條與倒數計時

**無障礙設計**：

- 語意化的 HTML 結構
- 鍵盤操作支援
- 顏色對比符合標準
- 清晰的錯誤訊息

### 錯誤處理

**網路錯誤**：

- 自動重連機制
- 重連失敗提示
- 保留已輸入資料

**輸入錯誤**：

- 即時驗證與提示
- 友善的錯誤訊息
- 明確的修正指引

**遊戲異常**：

- 房間不存在提示
- 遊戲已開始提示（轉為旁觀者）
- 權限不足提示

---

## 🔄 特殊情境處理

### 房間管理相關情境

以下情境涵蓋房間管理、玩家狀態、通訊同步等內容，詳見 [room_management.md](../docs/management/room_management.md#-特殊情況處理)：

- **斷線與重連**：自動重連機制、身份驗證、狀態同步
- **房主離線與轉移**：離線檢測、新房主選擇邏輯
- **旁觀者模式**：觸發條件、權限與限制
- **錯誤處理**：網路錯誤、輸入驗證錯誤、遊戲異常

### 遊戲邏輯相關情境

**衝突處理**（同一節點不同玩家的答案衝突）

詳見各階段規格文件：

- **第一階段**：[qa_phase1_relationship_check.md](../docs/features/qa_phase1_relationship_check.md) - 特殊情況處理
- **第二階段**：[qa_phase2_data_filling.md](../docs/features/qa_phase2_data_filling.md) - 邊界情況處理
- **第三階段**：[qa_phase3_data_check.md](../docs/features/qa_phase3_data_check.md) - 資料核查流程與衝突解決

---

## 🎲 遊戲平衡設計

### 時間設定

- **90 秒**：快速模式，適合小家庭（2-4 人）
- **120 秒**：標準模式，適合中型家庭（5-8 人）
- **180 秒**：完整模式，適合大家族（9 人以上）

### 問題數量控制

- 根據玩家數量動態調整
- 確保每位玩家有適當的參與度
- 避免資訊過載或過少

### 難度平衡

- 簡單問題（直系親屬）優先
- 複雜問題（旁系親屬）次之
- 避免過度追溯導致資訊爆炸
- MVFT 機制確保合理的深度限制

---

## 📈 未來擴展方向

### 功能擴展

- 支援更複雜的家庭結構（再婚、領養）
- 增加照片上傳功能
- 族譜匯出與分享
- 歷史記錄與回顧

### 社交功能

- 房間聊天功能
- 表情符號反應
- 語音提示
- 成就系統

### 資料持久化

- 資料庫儲存
- 帳號系統
- 家族檔案
- 長期追蹤

---

**文件版本**：1.0  
**最後更新**：2026-02-18  
**維護者**：Family Tree Game Project
