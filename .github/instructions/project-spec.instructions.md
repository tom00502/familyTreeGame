---
applyTo: "**"
---

# 家族族譜連連看 - 產品規格書

## 📋 產品概述

**家族族譜連連看 (Family Tree Connect)** 是一款專為親戚聚會設計的實時多人協作遊戲。玩家透過回答彼此的親屬關係、填寫家族成員資訊，在限定時間內共同拼湊出完整的家族族譜。遊戲強調真實性、協作性與趣味性，讓家族成員在遊戲過程中重新認識彼此的血緣關係。

### 核心價值

- **真實連結**：所有玩家為真實親戚，資料具備真實性與情感價值
- **協作競速**：全體玩家共同完成族譜，但依個人貢獻度計分
- **漸進揭曉**：遊戲過程中不顯示族譜全貌，結束時才進行「大揭曉」
- **社交樂趣**：透過問答互動，喚起家族記憶與共同話題

---

## 🎮 遊戲機制

### 基本規則

1. **玩家身份**：所有玩家必須是真實親屬關係
2. **遊戲時長**：可選 90 秒、120 秒或 180 秒
3. **最少人數**：至少 2 位玩家才能開始遊戲
4. **實時協作**：所有玩家同時進行，但不會即時看到他人的進度，只有系統知道每位玩家的填寫狀況
5. **資訊隱蔽**：遊戲進行時不顯示族譜結構，僅在結束時揭曉

### 遊戲流程

#### 階段 0：房間建立與加入

**房主操作**：

- 輸入房間名稱（例如：「王家族譜」）
- 選擇遊戲時長（90/120/180 秒）
- 系統生成唯一房間代碼
- 生成分享連結邀請家人

**加入者操作**：

- 透過分享連結或房間代碼加入
- 房間鎖定前可自由加入
- 遊戲開始後僅能以旁觀者身份進入

**玩家資料設定**（所有人必填）：

- **姓名**：2-10 個中文字元
- **性別**：男性或女性
- **完整出生日期**：YYYY/MM/DD 格式

**等待大廳功能**：

- 顯示已加入的玩家列表
- 即時顯示其他人正在輸入的狀態
- 房主可複製分享連結
- 房主可啟動遊戲（需至少 2 位玩家）

#### 階段 1：關係掃描 (Relationship Scan)

**目標**：確立玩家之間的親屬關係，建立族譜骨架

**提問形式**：二階段追問機制

**第一階段 - 選擇方向**：

```
「玩家 B 是在你的：
  □ 爸爸那邊的人（父系親戚）
  □ 媽媽那邊的人（母系親戚）
  □ 配偶那邊的人
  □ 子女那邊的人
  □ 完全不知道」
```

**第二階段 - 選擇具體稱謂**：
根據第一階段選擇的方向，系統顯示該方向內的所有親屬稱謂供選擇。系統會根據被詢問者的性別自動過濾不符合的稱謂選項。

**稱謂範圍**（涵蓋四等親內）：

- **父系**：爸爸、爺爺、曾祖父、伯父、叔叔、姑姑、堂兄弟姊妹等
- **母系**：媽媽、奶奶、曾祖母、舅舅、阿姨、表兄弟姊妹等
- **配偶系**：配偶（丈夫/妻子）
- **子女系**：兒子、女兒、孫子、孫女、曾孫等

**提問策略**：

- **玩家少於 4 人**：每位玩家詢問所有其他玩家的關係
- **玩家 4 人或以上**：每位玩家詢問 3 位其他玩家（系統智能分配，確保均勻覆蓋）

**玩家操作**：

- 在限時內回答兩階段問題
- 可選擇「跳過」將問題延後處理
- 選擇「完全不知道」則不進行第二階段追問

#### 階段 2：資料填充 (Data Sprint)

**目標**：填補虛擬節點的詳細資訊，完成最小可行族譜 (MVFT)

**核心概念 - 最小可行族譜 (MVFT)**：
系統根據第一階段的關係答案，自動生成連結玩家的虛擬節點（如父母、祖父母等）。第二階段的任務是填寫這些虛擬節點的資訊。

**MVFT 完成標準**：

1. **關鍵路徑連通**：所有有關係的玩家必須透過虛擬節點連結
2. **核心家庭完整**：關鍵節點的核心家庭單元（父母+配偶+所有子女）必須完整
3. **終端限制**：非關鍵路徑的旁系親屬僅需基本資訊（姓名、性別），不再延伸

**任務類型**：

1. **節點命名**：
   - 「你的爸爸叫什麼名字？」
   - 「請問這位姑姑叫什麼名字？」

2. **屬性填充**：
   - 「有人記得王大明的生日嗎？」
   - 「王大明大約幾歲？」

3. **向上追溯**：
   - 「請問王大明的父親是誰？」
   - 「王大明的母親叫什麼名字？」

4. **節點匯聚**：
   - 「你的爺爺是『王金剛』嗎？」（確認不同路徑指向同一人）

5. **排序確認**：
   - 「王大明與李小華誰的年紀比較大？」

**任務派發策略**：

- **優先級 1（路徑閉合）**：優先完成連結玩家的直接節點（父母、祖父母）
- **優先級 2（橫向補齊）**：完成配偶與手足資訊
- **優先級 3（屬性填充）**：完成生日、年齡等細節

**任務分配原則**：

- **關係親近優先**：任務優先派發給與該節點關係最近的玩家
- **獨佔提問**：同一任務同時只派發給一位玩家
- **跳過流轉**：玩家選擇「不知道」或「跳過」後，任務重新進入題目池

**玩家操作**：

- 快速回答系統派發的任務
- 可選擇「跳過」或「不知道」
- 無法看到完整族譜結構（保持神秘感）

#### 階段 3：大揭曉 (The Big Reveal)

**觸發時機**：遊戲時間結束

**揭曉動畫**：

- 從現場玩家節點開始
- 向外延伸展開整個家族樹結構
- 動態生成視覺化族譜圖

**結果呈現**：

- **族譜完整度**：顯示完成的節點數 vs 總節點數
- **個人貢獻**：每位玩家填寫的資訊數量
- **MVP 玩家**：得分最高的玩家
- **族譜結構**：完整的家族樹視覺呈現

---

## 🏗️ 系統功能規格

### 房間管理

**房間狀態**：

- **未啟動 (Idle)**：系統初始狀態，顯示建立房間表單
- **等待中 (Waiting)**：房間已建立，等待玩家加入
- **進行中 (In-Game)**：遊戲進行中，新加入者自動成為旁觀者
- **結算中 (Finished)**：遊戲結束，顯示結果與族譜

**房主權限**：

- 設定房間名稱與遊戲時間
- 啟動遊戲（需至少 2 位玩家）
- 房主離線時權限自動轉移給下一位玩家

**房間安全**：

- 唯一房間代碼
- 遊戲開始後自動鎖定（防止中途加入影響遊戲）
- 自動清理超過 24 小時的過期房間

### 玩家管理

**身份識別**：

- 每位玩家擁有唯一的 playerId
- playerId 儲存於瀏覽器 localStorage
- 支援斷線重連（保留身份與進度）

**玩家狀態**：

- **連線中 (Connected)**：正常遊戲狀態
- **輸入中 (Typing)**：其他人可看到該玩家正在輸入
- **離線 (Disconnected)**：暫時斷線，資料保留
- **旁觀者 (Observer)**：遊戲開始後加入，僅能觀看

**資料驗證**：

- 姓名長度限制：2-10 字元
- 性別必填：男性或女性
- 出生日期必填：有效的 YYYY/MM/DD 格式
- 即時驗證與錯誤提示

### 族譜系統

**節點類型**：

- **真實玩家節點**：實際參與遊戲的玩家
- **虛擬節點**：根據關係推導出的家族成員

**節點屬性**：

- **必填**：姓名、性別
- **選填**：出生日期、年齡、其他屬性
- **系統標記**：是否為關鍵節點、擴張類型

**關係類型**：

- **血緣關係**：父母、子女、兄弟姊妹
- **姻親關係**：配偶
- **親屬稱謂**：伯叔姑舅姨等擴展親屬

**族譜結構**：

- 有向無環圖 (DAG) 結構
- 支援多代追溯（依 MVFT 原則限制深度）
- 自動節點去重與匯聚

### 出題系統

**第一階段出題邏輯**：

- 玩家 < 4 人：完全配對（每人詢問所有其他人）
- 玩家 ≥ 4 人：均勻分配（每人詢問 3 位，確保覆蓋均勻）
- 支援性別過濾（根據被詢問者性別自動過濾不合理的稱謂）

**第二階段出題邏輯**：

- 關鍵路徑優先填充
- 根據玩家與節點的關係距離智能派發
- 任務獨佔機制（避免重複填寫）
- 動態更新（填寫後的節點自動反映在後續問題中）

**問題模板**：

- 節點命名：「{node_label} 叫什麼名字？」
- 屬性填充：「有人記得 {node_name} 的生日嗎？」
- 向上追溯：「{node_name} 的父親是誰？」
- 節點匯聚：「你的 {node_label} 是 {known_name} 嗎？」

### 計分系統

**計分項目**：

- 成功回答關係問題
- 填寫虛擬節點姓名
- 填寫屬性資訊（生日、年齡）
- 確認節點匯聚

**計分權重**：

- 關鍵路徑節點貢獻度較高
- 首次填寫資訊獲得完整分數
- 確認他人答案獲得較少分數

**結果呈現**：

- 個人總分排名
- MVP 玩家表揚
- 貢獻項目明細

### 即時通訊

**WebSocket 連線**：

- 持久連接，雙向通訊
- 自動重連機制（斷線後 3 秒內重試）
- 心跳檢測（30 秒間隔）

**狀態同步**：

- 玩家加入/離開即時廣播
- 輸入狀態即時顯示
- 遊戲階段切換同步
- 答題進度即時更新

**訊息類型**：

- 房間管理：建立、加入、開始、結束
- 玩家狀態：連線、斷線、輸入中
- 遊戲事件：問題派發、答案提交、階段切換
- 結果通知：族譜更新、計分變化

---

## 📊 資料結構規格

### 房間資料結構

```
房間 (Room)
├── roomId: 唯一識別碼
├── name: 房間名稱
├── gameDuration: 遊戲時長（秒）
├── status: 房間狀態（waiting/in-game/finished）
├── hostId: 房主玩家 ID
├── players: 玩家列表
├── gameStartTime: 遊戲開始時間
├── familyTree: 族譜圖資料
└── createdAt: 建立時間
```

### 玩家資料結構

```
玩家 (Player)
├── id: 唯一識別碼
├── name: 姓名
├── gender: 性別（male/female）
├── birthday: 出生日期
├── isHost: 是否為房主
├── isObserver: 是否為旁觀者
├── score: 得分
├── isTyping: 是否正在輸入
└── isConnected: 是否連線中
```

### 族譜節點資料結構

```
族譜節點 (FamilyNode)
├── id: 唯一識別碼
├── name: 姓名
├── gender: 性別
├── birthday: 出生日期（選填）
├── isVirtual: 是否為虛擬節點
├── isPlayer: 是否為玩家節點
├── playerId: 對應的玩家 ID（若為玩家節點）
├── isOnKeyPath: 是否在關鍵路徑上
├── expansionType: 擴張類型（FULL/TERMINAL）
├── father: 父親節點 ID
├── mother: 母親節點 ID
├── spouse: 配偶節點 ID
└── children: 子女節點 ID 列表
```

---

## 🎯 使用者體驗設計

### 視覺風格

**配色方案**：

- 主色：`#8B2635`（深紅色）- 象徵家族傳承
- 輔色：`#D4AF37`（金色）- 象徵榮耀與成就
- 背景：`#FAF8F3`（米白色）- 溫暖舒適
- 文字：`#5C2E2E`（深棕色）- 易讀穩重
- 次要：`#8B8278`（灰棕色）- 低調輔助

**設計元素**：

- 圓角設計（溫馨親和）
- 柔和漸層（視覺舒適）
- 大型圖示與表情符號（易理解）
- 清晰的按鈕狀態（操作反饋）

### 互動設計

**回應式設計**：

- 支援桌面與行動裝置
- 適應不同螢幕尺寸
- 觸控友善的按鈕大小

**即時反饋**：

- Loading 動畫（等待提示）
- 輸入驗證即時提示
- 操作成功/失敗提示
- 進度條與倒數計時

**無障礙設計**：

- 語意化的 HTML 結構
- 鍵盤操作支援
- 顏色對比符合標準
- 清晰的錯誤訊息

### 錯誤處理

**網路錯誤**：

- 自動重連機制
- 重連失敗提示
- 保留已輸入資料

**輸入錯誤**：

- 即時驗證與提示
- 友善的錯誤訊息
- 明確的修正指引

**遊戲異常**：

- 房間不存在提示
- 遊戲已開始提示（轉為旁觀者）
- 權限不足提示

---

## 🔄 特殊情境處理

### 斷線重連

**斷線處理**：

- 玩家狀態標記為離線
- 保留所有遊戲資料
- 其他玩家看到離線提示

**重連流程**：

- 透過 localStorage 的 playerId 自動識別
- 恢復玩家狀態與進度
- 同步當前遊戲階段
- 廣播重連通知

### 房主轉移

**觸發條件**：

- 房主斷線超過一定時間
- 房主主動離開房間

**轉移邏輯**：

- 自動選擇下一位玩家成為房主
- 優先選擇連線時間最長的玩家
- 廣播房主變更通知
- 新房主獲得完整權限

### 旁觀者模式

**觸發條件**：

- 遊戲開始後才加入房間

**旁觀者權限**：

- 可觀看遊戲進度
- 無法參與答題
- 不影響計分
- 可觀看最終結果

### 衝突處理

**衝突偵測**：

- 不同玩家對同一節點資訊回答不一致
- 節點匯聚時身份不符

**處理方式**：

- 標記為「待確認」狀態
- 推播給衝突雙方確認
- 採用多數決或可信度機制
- 必要時由房主仲裁

---

## 🎲 遊戲平衡設計

### 時間設定

- **90 秒**：快速模式，適合小家庭（2-4 人）
- **120 秒**：標準模式，適合中型家庭（5-8 人）
- **180 秒**：完整模式，適合大家族（9 人以上）

### 問題數量控制

- 根據玩家數量動態調整
- 確保每位玩家有適當的參與度
- 避免資訊過載或過少

### 難度平衡

- 簡單問題（直系親屬）優先
- 複雜問題（旁系親屬）次之
- 避免過度追溯導致資訊爆炸
- MVFT 機制確保合理的深度限制

---

## 📈 未來擴展方向

### 功能擴展

- 支援更複雜的家庭結構（再婚、領養）
- 增加照片上傳功能
- 族譜匯出與分享
- 歷史記錄與回顧

### 社交功能

- 房間聊天功能
- 表情符號反應
- 語音提示
- 成就系統

### 資料持久化

- 資料庫儲存
- 帳號系統
- 家族檔案
- 長期追蹤

---

**文件版本**：1.0  
**最後更新**：2026-02-18  
**維護者**：Family Tree Game Project
