# 出題策略規格書

## 策略概述

本文件獨立規範「家族族譜連連看」遊戲系統的**出題策略**——即系統如何決定向哪位玩家派發哪些題目。出題策略的核心目的是**透過智能分派，高效地構建完整的有序無環圖 (DAG) 族譜**。

---

## 📋 出題策略的角色與意義

### 為什麼需要獨立出題策略？

1. **複雜性獨立**：出題策略涉及多個維度的優化與決策邏輯，與房間管理、UI 展現等解耦
2. **核心競爭力**：決定了遊戲的流暢性、玩家體驗與族譜完整度
3. **易於迭代**：獨立規格便於測試、優化與日後的演算法升級
4. **可測試性**：便於進行單元測試與演算法驗證

### 出題策略的目標

- **高效建圖**：用最少時間內完成儘可能完整的族譜
- **公平分配**：根據玩家的關係親近度公平分派任務
- **衝突最小化**：降低玩家答案不一致的情況
- **玩家體驗**：確保每位玩家都獲得相關的、有趣的題目

---

## 📋 前提條件

所有出題策略的前提是：**遊戲開始前，所有要參與的玩家皆已連線**

### 意義

1. **完整參賽名單**：系統一開始就知道有哪些玩家參與，無需在遊戲進行中動態調整玩家集合
2. **固定提問範圍**：關係掃描的提問範圍是確定的（$\binom{n}{2}$ 對玩家關係）
3. **簡化派題邏輯**：不需要處理「遊戲中途加入」的複雜情況
4. **確保公平性**：所有玩家從遊戲開始就有相等的參與機會

---

## 🎯 三大出題階段

### 階段一：關係掃描 (Relationship Scan)

#### 目標

詢問玩家間的關係，以確定第二階段資料補齊時該填寫哪些虛擬節點、朝哪個方向建立族譜

#### 出題邏輯

**基本形式**：二階段追問機制

##### 第一階段：選擇方向

系統先詢問玩家該人屬於哪個方向的親戚：

```
系統詢問：「玩家 B 是在你的：
  □ 爸爸那邊的人（父系親戚）
  □ 媽媽那邊的人（母系親戚）
  □ 配偶那邊的人
  □ 子女那邊的人
  □ 完全不知道」
```

##### 第二階段：選擇具體稱謂

根據玩家在第一階段選擇的方向，系統進行第二階段追問，顯示該方向內的所有四等親稱謂：

```
示例：若玩家選擇「爸爸那邊的人」
系統詢問：「那麼，玩家 B 具體是你的誰？」
選項（父系）：爸爸、爺爺、曾祖父、伯父、叔叔、姑姑、哥哥、弟弟、姊姊、妹妹、堂兄弟、堂姐妹、堂侄子、堂甥女、表兄弟、表姐妹

示例：若玩家選擇「媽媽那邊的人」
系統詢問：「那麼，玩家 B 具體是你的誰？」
選項（母系）：媽媽、奶奶、曾祖母、舅舅、阿姨、哥哥、弟弟、姊姊、妹妹、堂兄弟、堂姐妹、表兄弟、表姐妹、表侄子、表甥女

示例：若玩家選擇「配偶那邊的人」
系統詢問：「那麼，玩家 B 具體是你的誰？」
選項：配偶（丈夫/妻子）

示例：若玩家選擇「子女那邊的人」
系統詢問：「那麼，玩家 B 具體是你的誰？」
選項：兒子、女兒、孫子、孫女、曾孫子、曾孫女

示例：若玩家選擇「完全不知道」
系統不進行第二階段追問，直接將此關係記錄為「待確認」狀態
```

完整的親屬稱謂列表（四等親內）：

```
父系：爸爸、爺爺、曾祖父、伯父、叔叔、姑姑、哥哥、弟弟、姊姊、妹妹、堂兄弟、堂姐妹、堂侄子、堂甥女、表兄弟、表姐妹
母系：媽媽、奶奶、曾祖母、舅舅、阿姨、哥哥、弟弟、姊姊、妹妹、堂兄弟、堂姐妹、表兄弟、表姐妹、表侄子、表甥女
配偶：配偶（丈夫/妻子）
子女：兒子、女兒、孫子、孫女、曾孫子、曾孫女
```

**性別過濾規則**（在第二階段應用）：

- 系統根據被詢問者的性別，在第二階段自動過濾該方向內不符合性別的稱謂
- 如果被詢問者是男性：過濾掉女性專屬稱謂（如媽媽、女兒等）
- 如果被詢問者是女性：過濾掉男性專屬稱謂（如爸爸、兒子等）
- **前提條件**：玩家必須在遊戲開始時填寫性別（必填項），系統不處理未指定性別的情況

#### 提問數量與頻率

**玩家少於 4 人**：直接詢問該玩家與所有其他玩家的關係

```完全不知道」的處理流程

當玩家在第一階段選擇「完全不知道」時（表示不知道該人屬於父系/母系/配偶/子女的任何方向）：

```

處理方式：

- 系統不進行第二階段具體稱謂追問
- 將此玩家間的關係記錄為「待確認」狀態
- 不對此關係做任何假設或預填

後續處理：

- 等待其他玩家提供的資訊來推斷兩人之間的關係
- 在階段二（資料補齊）中，其他玩家填寫相關虛擬節點時可能會補齊此資訊
- 若最終仍無法確定，該玩家可能形成獨立的族譜分支

異常情況：

- 若所有玩家之間都互相「完全不知道」，系統正常進入階段二
- 階段二只詢問與各玩家本身直接相關的虛擬節點（父母、祖父母等）
- 最終族譜可能包含多個不相交的樹狀結構
- 此為正常情況，系統不視為錯誤，無需特殊提示
  第一輪派題策略：
- 玩家 A 被詢問：B、C、D 是你的誰？
- 玩家 B 被詢問：A、C、E 是你的誰？
- 玩家 C 被詢問：A、D、E 是你的誰？
- 玩家 D 被詢問：B、C、E 是你的誰？
- 玩家 E 被詢問：A、B、D 是你的誰？

派題演算法目標：
✓ 每位玩家都被詢問 3 個其他玩家
✓ 所有玩家被詢問關係的次數盡可能均勻分布
✓ 若玩家數量 n 時無法完全均勻，差異控制在 ±1

說明：

- 5 人遊戲共 5 × 3 = 15 個問題
- 每位玩家平均被詢問 3 次（= 15 ÷ 5）

```

#### 「不知道」的處理流程

當玩家選擇「不知道」時，系統進行追問以幫助第二階段建立方向：

```

玩家 A 回答「不知道」玩家 B 是誰時，系統追問：

「那麼，玩家 B 是在你的：
□ 爸爸那邊的人（父系親戚）
□ 媽媽那邊的人（母系親戚）
□ 配偶那邊的人
□ 子女那邊的人
□ 完全不知道」

追問的作用：

- 確定族譜該朝哪個方向延伸
- 幫助系統建立虛擬節點的基本骨架
- 為第二階段資料補齊提供方向指引

```

#### 出題派發規則  | 派發方式       | 說明                                     |
| -------------- | -------------- | ---------------------------------------- |
| 玩家連線狀態   | 僅派給活躍玩家 | 離線玩家暫不派題                         |
| 玩家身份       | 排除旁觀者     | 只有參與遊戲的玩家收到題目               |
| 時間限制       | 待調整         | 秒數後續根據遊戲測試結果調整             |
| 同時派題數     | 全體玩家同時   | 所有活躍玩家同時接收自己的關係詢問       |
| 階段一完成條件 | 並行等待       | 所有玩家完成所有 3 個問題後一起進入階段二 |

**階段一完成的判定**：
- 每位玩家最多被詢問 3 個其他玩家（玩家 < 4 時為所有其他玩家）
- 每個問題包含第一階段（選擇方向）和可能的第二階段（選擇具體稱謂）
- 所有玩家完成所有第一階段問題（方向選擇）後，系統統一進入階段二
- 不需等待「完全不知道」的玩家完成任何額外步驟     |
| 時間限制     | 15-30 秒       | 足夠時間思考，但不能過長           |
| 同時派題數   | 全體玩家同時   | 所有活躍玩家同時接收自己的關係詢問 |

#### 虛擬節點自動生成

根據玩家間的關係回答，系統在中間自動生成虛擬節點，為第二階段資料補齊指明方向：

```

例1：玩家 A 回答「玩家 B 是我的兒子」
└─ 自動標記：需要填寫虛擬節點「A 的配偶（B 的母親）」方向

例2：玩家 A 回答「玩家 B 是我的叔叔」
└─ 自動標記：需要填寫虛擬節點「A 的父親、A 的祖父、叔叔的父親」等方向

例3：玩家 A 不知道「玩家 B」，但回答「B 是我媽媽那邊的人」
└─ 自動標記：需要在「母系方向」填寫虛擬節點

例4：玩家 A 與玩家 B 是夫妻，玩家 C 回答「B 是我的媽媽」
├─ 已確認：A ↔ B (配偶)，C → B (母)
└─ 自動標記：需要填寫「A 的其他配偶關係」或「B 的其他親屬」等方向

```

**關鍵規則**：

- 階段一只確認玩家間的直接關係，不會在此階段自動生成具體虛擬節點
- 關係確認結果會在第二階段指導虛擬節點的填寫方向與優先級
- 階段一完成後，進入「資料補齊階段」根據已確認關係填寫虛擬節點資訊

---

### 階段二：資料補齊 (Data Completion)

#### 目標

完成關係掃描後產生的虛擬節點資料填寫（姓名、性別、生日），使族譜更加完整

#### 出題形式

**以答題方式填寫虛擬節點**：

```

任務類型：填寫虛擬節點資料
目標節點：虛擬節點 (例如：玩家 A 的祖父)
問題卡片形式：
├─ [填寫姓名]
├─ [選擇性別]
└─ [輸入生日]
時間限制：玩家可自由決定（跳過 / 提交 / 鎖定）

```

#### 核心機制：獨佔提問規則 (Exclusive Quizzing)

這是資料搶答階段最重要的機制，確保**同一個節點在同一時間只分派給一位玩家**。

**機制說明**：

1. **單一派發**
   - 系統將任務 T 分派給玩家 P（根據優先級算法選出）
   - 只有玩家 P 看到任務 T
   - 其他玩家暫時無法看到該任務（任務從他們的潛在題目池中移除）

2. **任務流轉**
   - 玩家 P 可以：
     - **提交答案**：任務完成，累積分數
     - **跳過**：任務被移出 P 的任務列表，降低優先級
     - **超時未動作**：系統自動作為「跳過」處理

3. **鎖定機制**
   - 玩家 P 開始輸入（鎖定）時，服務器廣播 `task_lock` 事件
   - 其他玩家收到通知：「某某正在填寫該信息」
   - 該任務從其他玩家的潛在題目池中移除
   - 其他玩家無法搶答該任務

4. **重新分派**
   - 玩家 P 跳過或超時後，任務重新進入任務池
   - 系統根據優先級算法重新為任務分配接收者（可能是 Q、R 等其他玩家）
   - 新接收者同樣會獨佔該任務

**狀態轉換圖**：

```

未分派 ──[分派給玩家A]──> 分派中 ──[玩家A鎖定]──> 鎖定中
│ │
│ ┌─┴──────┐
[跳過/超時] [提交] [跳過]
│ │ │
↓ ↓ ↓
(優先級↓) 已完成 (優先級↓)
│ │ │
└──────────┬───────────┘ │
│ │
(可重新分派) ────────┘

```

#### 任務分派優先級算法

系統使用**多維度評分模型**決定將哪個任務分派給哪位玩家。

**優先級計算公式**：

```

Priority Score = (Distance Weight × Proximity) + (Contribution Weight × ContributionScore) + (RandomFactor × RandomValue) - (SkipPenalty × SkipCount)

其中：

- Distance Weight = 0.6 (遠近優先權)
- Contribution Weight = 0.2 (貢獻度)
- RandomFactor = 0.1 (隨機因子，增加多樣性)
- SkipPenalty = 0.1 (跳過懲罰)

```

**各維度詳解**：

##### 1. **關係鄰近度優先 (Proximity Score)**

根據玩家與目標節點在 DAG 中的**物理距離**計算：

```

距離計算方式：BFS (廣度優先搜尋)

例子：

- 目標節點：玩家 A 的祖父
- 玩家 A 到目標：距離 = 1
- 玩家 B (A 的兄弟) 到目標：距離 = 1
- 玩家 C (A 的配偶) 到目標：距離 = 2
- 玩家 D (無關) 到目標：距離 = ∞

優先派給距離 ≤ 2 的玩家

````

**優先級分布**：

| 距離 | 優先級分值 | 說明                         |
| ---- | ---------- | ---------------------------- |
| 1    | 100        | 直系親屬（父母、子女、配偶） |
| 2    | 80         | 祖父母、兄弟姐妹、舅舅姑姑   |
| 3    | 60         | 堂親、表親                   |
| 4    | 40         | 遠親                         |
| ≥ 5  | 20         | 極遠親戚                     |
| ∞    | 0          | 無直接關係，最後派遣         |

##### 2. **貢獻度積分 (Contribution Score)**

根據玩家已填寫的任務數量與品質：

```typescript
ContributionScore = min(
  (CompletedTaskCount / MaxTaskCount) × 100,
  100
)

// 若玩家已完成 5 個任務，MaxTaskCount = 20
// ContributionScore = 5/20 × 100 = 25 分
````

**作用**：確保所有玩家都有相等的參與機會，防止某位玩家一直獲得任務。

##### 3. **跳過懲罰 (Skip Penalty)**

跳過會降低玩家在後續任務分派中的優先級：

```
每次跳過 → Priority 降低 0.1
連續 3 次跳過 → 該玩家暫時被加入「冷卻名單」，3 分鐘內不再派題
```

**原理**：鼓勵玩家認真作答，避免濫用跳過功能。

##### 4. **隨機因子 (Random Factor)**

引入輕微隨機性增加遊戲的多樣性：

```
RandomValue = [0, 1] 之間的隨機數
RandomFactor × RandomValue = [0, 0.1] 的隨機加值

作用：
- 防止演算法過度決定論
- 增加遊戲的不可預測性
- 給予每位玩家相等的「運氣」機會
```

#### 派題流程 (Task Assignment Workflow)

```
1. [系統初始化]
   生成待派任務列表 TaskQueue
   篩選活躍玩家 ActivePlayers

2. [計算優先級]
   FOR EACH 任務 T IN TaskQueue:
     FOR EACH 玩家 P IN ActivePlayers:
       計算 P 對 T 的優先級分數

3. [選出最優配對]
   找到最高優先級的 (玩家, 任務) 配對
   (例如：玩家 Alice 對「祖父姓名」的優先級最高)

4. [派發與鎖定]
   將任務派給玩家 Alice
   廣播 `task_assigned` 事件
   將任務標記為 `locked: true`
   從其他玩家的潛在題目池中移除該任務

5. [等待玩家反應]
   Alice 有 30 秒時間作選擇：
   - 提交答案 → 任務完成，計分，進入步驟 2
   - 跳過 → 任務重新進入佇列（優先級降低），進入步驟 2
   - 無動作（超時）→ 同跳過處理

6. [派題完成條件]
   TaskQueue 為空 AND
   所有玩家都不再接收新任務
   → 遊戲進入「大揭曉」階段
```

---

## 🔄 任務流轉示例

### 情景 1：3 人家庭遊戲（玩家數 < 4）

**初始狀態**：

- 玩家 A（祖父，男）、B（父親，男）、C（兒子，男）

**階段一：關係掃描**

由於玩家少於 4 人，系統詢問所有玩家對的關係：

| 步驟 | 派發對象 | 詢問內容     | 玩家答案 | 備註                   |
| ---- | -------- | ------------ | -------- | ---------------------- |
| 1    | A        | B 是你的誰？ | 兒子     | 確認 A → B（父子）     |
| 2    | A        | C 是你的誰？ | 孫子     | 確認 A → C（祖孫）     |
| 3    | B        | A 是你的誰？ | 爸爸     | 確認 B → A（父子逆向） |
| 4    | B        | C 是你的誰？ | 兒子     | 確認 B → C（父子）     |
| 5    | C        | A 是你的誰？ | 爺爺     | 確認 C → A（祖孫逆向） |
| 6    | C        | B 是你的誰？ | 爸爸     | 確認 C → B（父子逆向） |

**階段一結果**：

- 確認關係：A 父 B 子，B 父 C 子
- 指導方向：
  - 需要填寫 A 的配偶（C 的祖母）方向
  - 需要填寫 A 的父親（C 的曾祖父）方向

**階段二：資料補齊** 開始派發虛擬節點填寫任務

---

### 情景 2：5 人家庭遊戲（玩家數 ≥ 4）

**初始狀態**：

- 玩家 A、B、C、D、E（性別及親緣關係初期未知）

**階段一：關係掃描**

由於玩家 ≥ 4 人，系統固定詢問每位玩家其他 3 位玩家的關係：

| 步驟 | 派發對象 | 詢問內容               | 玩家答案             | 備註                          |
| ---- | -------- | ---------------------- | -------------------- | ----------------------------- |
| 1    | A        | B、C、D 分別是你的誰？ | 妻子、兒子、表兄     | A 回答 3 個                   |
| 2    | B        | A、C、E 分別是你的誰？ | 丈夫、女兒、不知道   | B 回答 3 個，C 是配偶那邊的人 |
| 3    | C        | A、D、E 分別是你的誰？ | 爸爸、舅舅、表哥     | C 回答 3 個                   |
| 4    | D        | B、C、E 分別是你的誰？ | 不知道、侄女、不知道 | D：B 是媽媽那邊，E 不確定     |
| 5    | E        | A、B、D 分別是你的誰？ | 爺爺、奶奶、舅舅     | E 回答 3 個                   |

**階段一結果**：

- 確認關係：A ↔ B（配偶），A → C（父子），B → C（母子），C → A（配偶），C → D（表親），等
- 不確定關係：已標記待確認
- 追問結果：已記錄「媽媽那邊、爸爸那邊」等方向信息

**階段二：資料補齊** 根據已知關係的方向優先派發虛擬節點填寫任務

---

## 🎮 遊戲進行中的出題狀態管理

### Task 資料結構

```typescript
interface Task {
  id: string; // 唯一任務 ID
  type: "relationship" | "node-info" | "conflict-resolution";

  // 目標信息
  targetNodeId: string; // 目標節點 ID
  question: string; // 問題描述（如：「誰是祖父」）

  // 分派狀態
  assignedTo?: string; // 當前分派給的玩家 ID
  isLocked: boolean; // 是否被鎖定（正在作答中）
  priority: number; // 當前優先級 (0-100)

  // 相關信息
  relatedPlayers: string[]; // 相關玩家 ID（用於距離計算）
  conflictWith?: string; // 衝突來源玩家 ID（僅衝突任務）

  // 時間管理
  createdAt: number; // 建立時間
  assignedAt?: number; // 派發時間
  deadline?: number; // 截止時間（30 秒後）

  // 結果
  answer?: any; // 玩家提交的答案
  filledBy?: string; // 實際填寫者的 playerId
  submittedAt?: number; // 提交時間
}
```

### 任務狀態機

```
[未派發]
   ↓
 派發給玩家 A
   ↓
[分派中] ← ← ← 玩家 A 在看任務但未鎖定
   ↓
 玩家 A 點擊任務 / 開始輸入
   ↓
[鎖定中] ← ← ← 只有 A 能作答，其他玩家看不到該任務
   ├─ [玩家 A 提交答案]
   │   ↓
   │ [已完成] → 計分 → 進入「資料庫」
   │
   ├─ [玩家 A 跳過]
   │   ↓
   │ [待重派] → 優先級↓ → 派給玩家 B
   │
   └─ [玩家 A 超時（無動作 30s）]
       ↓
     [待重派] → 優先級↓ → 派給玩家 B
```

---

### 階段三：資料驗證 (Data Verification)

#### 目標

詢問一些已完成的節點關係和資料，讓玩家來驗證是否正確，確保族譜的準確性

#### 出題形式

**驗證型題目**：詢問關於已填寫節點的問題，玩家選擇是否正確

```
驗證題形式 1：關係確認
「根據之前的回答，玩家 A 是玩家 B 的父親，這是否正確？」
選項：[正確], [有誤], [不確定]

驗證題形式 2：資料確認
「根據之前的填寫，玩家 A 的祖父姓名是『王小明』，性別為男性，生日是 1945/01/01。
這些信息是否全部正確？」
選項：[全部正確], [有誤], [不確定]

驗證題形式 3：選擇驗證
「以下哪項關於本次族譜的敘述是正確的？」
選項：[A 是 B 的祖父], [B 是 C 的叔叔], [C 和 D 是表親], [都不對]
```

#### 驗證題的選擇邏輯

1. **隨機抽樣**：從已完成的節點和關係中隨機選取進行驗證
2. **關鍵節點優先**：優先驗證高度數 (degree) 較高的節點（影響範圍大的關係）
3. **衝突歷史**：如果某個節點曾有衝突記錄，提高其被驗證的優先級
4. **玩家知識範圍**：只向玩家提出他們應該知道的資訊（與自己在 DAG 中有路徑連接的節點）

#### 衝突與資料不一致的處理

**檢測場景**：

```
場景 1：驗證時發現新的資料矛盾
- 玩家 A 在資料補齊階段填寫：祖父的性別 = 男
- 玩家 B 在驗證階段否定：「祖父是女性」
→ 系統檢測到衝突，觸發「衝突解決任務」

場景 2：驗證時玩家選擇「不確定」
- 玩家 C 不確定某個關係或資料
→ 系統標記該節點為「待確認」，稍後可再次驗證或由其他玩家確認

場景 3：多位玩家驗證結果不一致
- 玩家 D 驗證通過，玩家 E 驗證否定
→ 觸發「多方衝突解決」，由房主或更多玩家參與決策
```

**衝突解決任務**（同時派給有衝突的玩家）：

```
衝突解決任務：
├─ 任務 ID: conflict_verify_20250217_001
├─ 類型: conflict-resolution
├─ 目標節點: V1 (祖父)
├─ 衝突內容:
│  ├─ 玩家 A 說：性別是「男」(來自資料補齊階段)
│  └─ 玩家 B 驗證：「這個信息有誤」(來自驗證階段)
├─ 派發給: [玩家 A, 玩家 B]
└─ 選項:
   ├─ 同意 A 的答案（性別 = 男）
   ├─ 同意 B 的答案（性別 = 女）
   └─ 都不確定，標記為「待確認」
```

**解決流程**：

1. 衝突的雙方（或多方）同時收到衝突任務
2. 各自選擇一個選項（若選擇一致 → 衝突解決）
3. 若選擇仍有分歧 → 觸發「人工確認」（由房主或在場長輩決定）

---

## ⚖️ 衝突檢測與解決

### 衝突場景

**場景 1：對同一個人的描述矛盾**

```
節點 V1 (祖父)
├─ 玩家 A 填寫：姓名 = "王小明"，性別 = "男"，生日 = "1945/01/01"
├─ 玩家 B 稍後填寫：姓名 = "王曉民"，性別 = "女"，生日 = "1945/06/06"
→ 檢測衝突：姓名、性別、生日都不匹配
```

**場景 2：關係不一致**

```
A 說：C 是我的兒子
B 說：C 是我的兄弟
→ DAG 驗證時發現環路或矛盾
```

### 衝突檢測觸發點

1. **新資料提交時**（資料補齊階段）
   - 檢查新資料是否與已有資料衝突
   - 如果衝突，立即觸發「衝突解決任務」

2. **驗證階段**（資料驗證階段）
   - 玩家驗證已完成的資料時發現不一致
   - 觸發「衝突解決任務」

3. **DAG 驗證時**
   - 檢查新關係是否造成環路或矛盾
   - 如果發現，停止確認，改為衝突解決

---

## 🧮 計分系統

出題策略中的計分維度：

### 基礎計分

每完成一個任務，玩家獲得 **10 分**：

```
CompletedTask += 10 points
```

### 獎勵機制

1. **快速完成獎勵**
   - 在 10 秒內提交：+5 分
   - 在 20 秒內提交：+3 分

2. **準確性獎勵**
   - 答案與最終確認一致：+5 分
   - 衝突解決時選擇正確答案：+10 分

3. **首次填寫獎勵**
   - 第一位填寫某節點的玩家：+5 分

4. **貢獻度獎勵**
   - 完成所有派給的任務（不跳過）：遊戲結束後 +10 分

### 扣分機制

- **跳過懲罰**：每次跳過 -2 分（防濫用）
- **超時自動跳過**：自動扣 -2 分

### 最終排名

```
Final Score = Base Score + Speed Bonus + Accuracy Bonus - Skip Penalty

MVP = 得分最高的玩家（顯示在「大揭曉」階段）
```

---

## 🔀 邊界情況與異常處理

### 1. **玩家離線與重連**

| 情況     | 處理方式                                 |
| -------- | ---------------------------------------- |
| 玩家離線 | 標記為離線，暫停派題給他，已派題重新分派 |
| 玩家重連 | 恢復線上狀態，未完成的任務仍可繼續作答   |

### 2. **任務池耗盡**

```
IF TaskQueue 為空 AND 所有玩家都完成分派:
  └─ 進入「大揭曉」階段
  └─ 不再派題，等待遊戲結束
```

### 3. **超時自動處理**

```
IF 玩家 P 獲派任務 T，30 秒無反應:
  ├─ 自動作為「跳過」處理
  ├─ 任務 T 重新進入佇列
  ├─ 玩家 P 扣 -2 分
  └─ 優先級 Priority(P) 降低 20%
```

### 4. **關係鎖定**

```
IF 玩家 A & B 的關係已確認:
  └─ 系統永久記錄該關係
  └─ 不再提問同一對玩家的關係
  └─ 若後續有矛盾提交，觸發衝突解決
```

### 5. **驗證階段中的「待確認」狀態**

```
IF 玩家在驗證階段選擇「不確定」:
  ├─ 將該節點標記為「待確認」
  ├─ 稍後可由其他玩家驗證或確認
  └─ 遊戲結束時仍未確認的節點會在「大揭曉」中標註
```

---

## 📊 性能考量

### 複雜度分析

| 操作                     | 時間複雜度     | 說明                             |
| ------------------------ | -------------- | -------------------------------- |
| 計算單個玩家到節點的距離 | O(V + E)       | BFS 遍歷 DAG                     |
| 全玩家優先級計算         | O(P × (V + E)) | P = 玩家數，V = 節點數，E = 邊數 |
| 任務分派                 | O(log T)       | T = 待派任務數（使用優先級佇列） |
| 衝突檢測                 | O(C × V)       | C = 已確認衝突數                 |

### 優化建議

1. **快取距離計算**
   - 預計算常用節點對間的距離
   - 新節點添加時增量更新

2. **優先級佇列 (Heap)**
   - 使用二叉堆管理待派任務
   - O(log T) 時間快速取出最高優先級任務

3. **批次處理**
   - 每 500ms 進行一次批量派題
   - 避免頻繁的狀態同步

---

## 🧪 出題策略測試用例

### 測試場景 1：小家庭（3 人，玩家 < 4）

```
玩家：
- A（祖父，男）
- B（父親，男，A 的兒子）
- C（孫子，男，B 的兒子）

預期任務流：

階段一 - 關係掃描（< 4 人，詢問全部玩家對）：
  ✓ 系統問 A：「B 是你的誰？」→ A 答：兒子
  ✓ 系統問 A：「C 是你的誰？」→ A 答：孫子
  ✓ 系統問 B：「A 是你的誰？」→ B 答：爸爸
  ✓ 系統問 B：「C 是你的誰？」→ B 答：兒子
  ✓ 系統問 C：「A 是你的誰？」→ C 答：爺爺
  ✓ 系統問 C：「B 是你的誰？」→ C 答：爸爸

  結果：確認 A → B（父子），B → C（父子）

階段二 - 資料補齊（根據關係指導方向）：
  ✓ 標記需填寫方向：A 的配偶（C 的祖母）、A 的父親（C 的曾祖父）等
  ✓ 派題給 A、B、C 填充虛擬節點資訊

階段三 - 資料驗證：
  ✓ 驗證已填寫資訊的準確性

目標：完成至少 70% 的族譜資訊
```

### 測試場景 2：中型家庭（5 人，玩家 ≥ 4）

```
玩家：
- A（爺爺，男）
- B（奶奶，女，A 配偶）
- C（父親，男，A 之子）
- D（叔叔，男，A 之子）
- E（自己，男，C 之子）

預期任務流：

階段一 - 關係掃描（≥ 4 人，每位玩家詢問 3 人）：
  提問組合需確保每位玩家被詢問次數均勻分布

  範例派題方案：
  ✓ A 被問：B、C、D 是你的誰？（3 個）
  ✓ B 被問：A、C、E 是你的誰？（3 個）
  ✓ C 被問：A、D、E 是你的誰？（3 個）
  ✓ D 被問：B、C、E 是你的誰？（3 個）
  ✓ E 被問：A、B、D 是你的誰？（3 個）

  總共 15 個提問，每位玩家被詢問 3 次

  若玩家回答「不知道」，系統追問方向（爸爸邊、媽媽邊、配偶邊、子女邊）

  結果：建立族譜的基本方向框架

階段二 - 資料補齊：
  根據階段一的關係確認派發虛擬節點填寫任務

階段三 - 資料驗證：
  驗證關鍵節點的資訊準確性

目標：完成 80%+ 的族譜深度與驗證
```

### 測試場景 3：大型家庭（8 人，玩家 ≥ 4）

```
玩家：
- A（爺爺，男）
- B（奶奶，女，A 配偶）
- C（父親，男，A 之子）
- D（叔叔，男，A 之子）
- E（自己，男，C 之子）
- F（兄弟，男，C 之子，與 E 同母異父）
- G（表妹，女，D 的女兒）
- H（配偶，女，與 E 結婚）

預期任務流：

階段一 - 關係掃描（≥ 4 人，每位玩家詢問 3 人）：
  共 8 × 3 = 24 個提問
  每位玩家被詢問 3 次
  需要智能選擇 3 位詢問對象，確保族譜連貫性

  結果：建立完整的族譜關係框架

階段二 - 資料補齊：
  根據階段一確認的關係派發 20+ 個虛擬節點填寫任務

階段三 - 資料驗證：
  驗證關鍵節點的資訊準確性

目標：完成 90%+ 的族譜完整度
```

### 測試場景 4：衝突檢測與解決

```
情景：

階段一 - 關係掃描中的潛在衝突：
  - 玩家 A 回答：「玩家 B 是我的兒子」
  - 玩家 B 回答：「玩家 A 是我的哥哥」
  → 系統檢測矛盾，需要衝突解決

資料補齊階段產生衝突：
  - 玩家 A 填寫：祖父姓名 = "王小明"
  - 玩家 B 填寫：祖父姓名 = "王曉民"
  → 系統檢測衝突，派發衝突解決任務

驗證階段產生衝突：
  - 玩家 A 驗證：確認祖父性別 = 男
  - 玩家 B 驗證：否定此信息（說祖父是女性）
  → 系統檢測衝突，派發衝突解決任務

測試點：
  - 衝突檢測是否正確觸發
  - 衝突任務是否派給雙方
  - 衝突解決後計分是否正確
  - 「不知道」追問是否能有效避免某些衝突
```

- 是否派給合適的下一玩家
- 連續跳過是否觸發冷卻名單

```

---

## 📝 WebSocket 事件 (出題策略相關)

### 關係掃描階段事件

| 事件名稱                    | 發送方 | 接收方 | 資料結構                                                               | 說明                                   |
| --------------------------- | ------ | ------ | ---------------------------------------------------------------------- | -------------------------------------- |
| `relationship_question`     | Server | Client | `{ type, questionId, targetPlayerId, question, answerOptions[] }`       | 推送關係提問（選項已按性別過濾）       |
| `relationship_answer`       | Client | Server | `{ type, questionId, playerId, answer }`                               | 回答關係                               |
| `unknown_direction_question` | Server | Client | `{ type, questionId, playerId, targetPlayerId, directions[] }`          | 追問「不知道」方向（爸爸邊、媽媽邊等） |
| `unknown_direction_answer`   | Client | Server | `{ type, questionId, playerId, direction }`                            | 回答不知道方向                         |
| `relationship_confirmed`    | Server | All    | `{ type, player1, player2, relationship, direction?, confirmed: true }` | 關係確認與方向標記                     |

### 資料補齊階段事件

| 事件名稱              | 發送方 | 接收方 | 資料結構                                    | 說明                     |
| --------------------- | ------ | ------ | ------------------------------------------- | ------------------------ |
| `task_assigned`       | Server | Client | `{ type, task }`                            | 分派任務給玩家           |
| `task_lock`           | Client | Server | `{ type, taskId, playerId }`                | 玩家鎖定任務（開始作答） |
| `task_lock_broadcast` | Server | All    | `{ type, taskId, playerId }`                | 廣播任務已被鎖定         |
| `task_submit`         | Client | Server | `{ type, taskId, playerId, data }`          | 提交任務答案             |
| `task_skip`           | Client | Server | `{ type, taskId, playerId }`                | 跳過任務                 |
| `task_completed`      | Server | All    | `{ type, taskId, nodeId, filledBy, score }` | 任務完成通知             |
| `task_reassigned`     | Server | Client | `{ type, task }`                            | 任務重新分派             |

### 資料驗證階段事件

| 事件名稱                | 發送方 | 接收方 | 資料結構                                      | 說明             |
| ----------------------- | ------ | ------ | --------------------------------------------- | ---------------- |
| `verification_question` | Server | Client | `{ type, questionId, nodeId, content }`       | 推送驗證問題卡片 |
| `verification_answer`   | Client | Server | `{ type, questionId, playerId, answer }`      | 提交驗證答案     |
| `verification_result`   | Server | All    | `{ type, questionId, nodeId, result, score }` | 驗證結果通知     |

### 衝突解決事件

| 事件名稱              | 發送方 | 接收方              | 資料結構                                                    | 說明         |
| --------------------- | ------ | ------------------- | ----------------------------------------------------------- | ------------ |
| `conflict_detected`   | Server | Conflicting Players | `{ type, conflictId, nodeId, answer1, answer2, players[] }` | 偵測到衝突   |
| `conflict_resolution` | Client | Server              | `{ type, conflictId, playerId, chosenAnswer }`              | 衝突解決選擇 |
| `conflict_resolved`   | Server | All                 | `{ type, conflictId, finalAnswer }`                         | 衝突已解決   |

---

## 📚 相關文件與接口

### 與其他規格的關係

```

出題策略規格書 (QUESTION_STRATEGY_SPEC.md)
├─ 房間管理規格 (CONNECTION_SPEC.md)
│ └─ 房間鎖定、玩家狀態同步
├─ 系統整體設計 (SYSTEM_INSTRUCTIONS.md)
│ └─ WebSocket 事件、任務分派演算法
└─ 實作詳細 (IMPLEMENTATION_NOTES.md)
└─ 前端/後端具體實作

```

### 需要實作的模組

| 模組             | 位置                              | 責任                           |
| ---------------- | --------------------------------- | ------------------------------ |
| **任務分派器**   | `server/utils/taskAssigner.ts`    | 計算優先級、選擇玩家、派發任務 |
| **距離計算器**   | `server/utils/taskAssigner.ts`    | BFS 計算節點間距離             |
| **優先級評分器** | `server/utils/taskAssigner.ts`    | 多維度評分與排序               |
| **衝突檢測器**   | `server/utils/dagValidator.ts`    | 檢測資料與關係衝突             |
| **計分系統**     | `server/utils/scoreCalculator.ts` | 計算玩家分數與獎勵             |
| **任務管理器**   | `server/utils/gameState.ts`       | 管理任務佇列與狀態             |

---

## ✅ 驗證檢查清單

在實作出題策略前，確保已理解以下新設計要點：

### 階段一：關係掃描相關
- [ ] 理解玩家 < 4 和 ≥ 4 時的不同提問策略
- [ ] 掌握性別過濾關係選項的邏輯
- [ ] 理解「不知道」時的追問流程（爸爸邊、媽媽邊、配偶邊、子女邊）
- [ ] 掌握玩家人數 ≥ 4 時如何選擇 3 位詢問對象並確保均勻分布
- [ ] 理解階段一只關注「確認玩家間關係」，不在此階段生成虛擬節點

### 階段二：資料補齊相關
- [ ] 理解虛擬節點的產生是基於階段一的關係確認
- [ ] 掌握「獨佔提問」的含義與重要性
- [ ] 掌握優先級算法的四個維度

### 階段三：資料驗證相關
- [ ] 理解驗證題的三種形式

### 整體理解
- [ ] 理解 DAG 與虛擬節點的概念
- [ ] 理解三個階段的明確分工
- [ ] 掌握衝突檢測與解決的流程
- [ ] 理解任務狀態轉換機制
- [ ] 掌握計分與獎勵規則
- [ ] 理解 WebSocket 事件的完整流程
- [ ] 能夠手工模擬 3 人家庭的完整三階段遊戲流程
- [ ] 能夠手工模擬 5 人家庭的階段一提問分配

---

## 📞 待補充規格

本規格書已建立三個階段的基本框架，新版阶段一已聚焦于「僅詢問玩家間關係」，後續需要為各階段補充以下內容：

### 階段一：關係掃描 （核心補充）

- [ ] **完整的親屬稱謂列表**（已初步列出四等親內，需確認是否足夠）
  - [ ] 父系：爸爸、爺爺、曾祖父、伯父、叔叔、堂兄弟/姐妹、堂侄子/甥女
  - [ ] 母系：媽媽、奶奶、曾祖母、舅舅、阿姨、表兄弟/姐妹、表侄子/甥女
  - [ ] 配偶：丈夫/妻子
  - [ ] 子女：兒子、女兒、孫子、孫女、曾孫子/孫女

- [ ] **玩家 ≥ 4 人時選擇 3 位詢問對象的演算法**
  - [ ] 如何確保每位玩家被詢問次數均勻分布？
  - [ ] 是否優先選擇能建立族譜連貫性的玩家組合？
  - [ ] n 人時無法完全均勻時的處理方案（差異 ±1）

- [ ] **「不知道」追問的四個方向分類**
  - [ ] 爸爸那邊的人（父系）
  - [ ] 媽媽那邊的人（母系）
  - [ ] 配偶那邊的人
  - [ ] 子女那邊的人

- [ ] **性別過濾邏輯的詳細規則**
  - [ ] 男性被詢問時應過濾哪些女性稱謂
  - [ ] 女性被詢問時應過濾哪些男性稱謂
  - [ ] 邊界情況（無法確定性別、跨性別等）的處理

- [ ] **階段一完成的判定條件**
  - [ ] 是否所有玩家都需要被詢問完成才進入階段二？
  - [ ] 是否允許在某些玩家回答「完全不知道」的情況下提前結束階段一？

### 階段二：資料補齊

- [ ] 每個虛擬節點應填寫的必填/選填項目
- [ ] 資料輸入的格式驗證規則
- [ ] 派題優先級算法的詳細參數（基於階段一的確認關係）
- [ ] 任務鎖定與重派的完整機制

### 階段三：資料驗證

- [ � 設計決策記錄

以下是針對階段一設計的已確定決策和待決策項目：

### ✅ 已確定的設計決策

#### 1. 親屬稱謂列表與文化支援

**決策**：採用二階段追問機制，避免選項過多
- **第一階段**：選擇方向（爸爸邊、媽媽邊、配偶邊、子女邊、完全不知道）
- **第二階段**：根據方向顯示該方向內的具體稱謂

**完整稱謂列表**（已補充「姑姑」）：
- 父系：爸爸、爺爺、曾祖父、伯父、叔叔、姑姑、堂兄弟、堂姐妹、堂侄子、堂甥女、表兄弟、表姐妹
- 母系：媽媽、奶奶、曾祖母、舅舅、阿姨、堂兄弟、堂姐妹、表兄弟、表姐妹、表侄子、表甥女
- 配偶：配偶（丈夫/妻子）
- 子女：兒子、女兒、孫子、孫女、曾孫子、曾孫女

**文化支援**：
- ❌ 不需要支援其他文化背景的親屬稱謂
- ❌ 不需要支援「再婚、領養」等特殊親屬關係

#### 2. 「完全不知道」的處理

**決策**：不做任何處理，讓其他玩家來決定族譜方向
- 系統不進行第二階段追問
- 記錄為「待確認」狀態
- 由其他玩家或階段二的資訊來補齊
- 允許最終族譜包含多個不相交的樹狀結構

#### 3. 性別過濾規則

**決策**：玩家必須填寫性別
- 玩家在遊戲開始時**必須填寫性別**（必填項）
- 系統在第二階段根據性別自動過濾不符合的稱謂
- ❌ 不考慮跨性別等邊界3
**建立日期**: 2026-02-17
**最後更新**: 2026-02-17
**維護者**: Development Team
**狀態**: 階段一核心設計已確定（採用二階段追問機制），所有關鍵設計決策已記錄，待實作演算法細節
- 每個問題的回答時間限制：**後續根據測試調整**
- 階段一問題數量：**每位玩家最多 3 個問題**（玩家 < 4 時為所有其他玩家）
- 階段一完成條件：**所有玩家完成所有第一階段問題後，一起進入階段二**
- ❌ 不允許因超時或「完全不知道」而提早進入階段二

#### 5. 異常情況處理

**決策**：允許多樹結構，正常處理
- 若所有玩家互相不認識：正常進入階段二
- 階段二只詢問與各玩家本身有關的虛擬節點
- 最終可能生成多個不相交的樹狀結構
- ✅ 此為正常情況，無需特殊錯誤提示

### ⏳ 待決策或待補充的項目

#### 玩家 ≥ 4 人時的提問分配演算法

**狀態**：暫時擱置，後續再處理
- 目標：每位玩家被詢問 3 次，差異控制在 ±1
- 考慮項目：
  - 如何確保均勻分布
  - 是否考慮族譜連貫性
  - 是否利用先驗知識（如同姓推測）
- **優先級**：中（階段一其他部分可先實作）
5. **階段一的時間管理**
   - 每個提問的回答時間限制（目前規格為 15-30 秒）是否適當？
   - 如果玩家多次超時或回答不知道，是否應該允許提早進入階段二？

6. **異常情況的處理**
   - 如果所有玩家都互相不知道關係，系統如何引導進入階段二？
   - 是否存在「無法進行族譜建立」的情況，系統應該如何提示？

---

**文件版本**: v1.2
**建立日期**: 2026-02-17
**最後更新**: 2026-02-17
**維護者**: Development Team
**狀態**: 階段一規格已根據新設計更新，待補充詳細算法與邊界規則
```
