# 階段 3：資料確認與大揭曉 (Data Verification & Big Reveal)

## 📌 階段概述

**觸發時機**：遊戲設定的時間（90/120/180 秒）耗盡

**玩家體驗**：遊戲暫停，系統進行最後的資料驗證與衝突解決，然後展開動畫揭曉完整的家族族譜，最後顯示排行榜與個人貢獻統計

**系統目標**：驗證、確認和展示最終的族譜結果，進行計分與排名

---

## 🔍 資料核查流程

### 步驟 1：自動衝突檢測

系統掃描所有收集到的答案，自動檢測以下衝突：

#### 衝突類型 1：屬性衝突

**定義**：同一個節點關於同一個屬性有多個不同的答案

```
例1：生日衝突
  - 玩家 A 填寫：「爺爺的生日是 1950-01-01」
  - 玩家 B 填寫：「爺爺的生日是 1950-01-02」
  → 檢測到衝突，標記為 `conflict_type: date_mismatch`

例2：性別衝突
  - 玩家 A 填寫：「堂兄是男性」
  - 玩家 B 填寫：「堂兄是女性」
  → 檢測到衝突，標記為 `conflict_type: gender_mismatch`

例3：姓名衝突（同人多名字）
  - 玩家 A 填寫：「爺爺叫『王大明』」
  - 玩家 B 填寫：「爺爺叫『王大民』」（可能誤寫或別名）
  → 檢測到衝突，標記為 `conflict_type: name_variant`
```

#### 衝突類型 2：關係衝突

**定義**：關於某玩家間的關係有矛盾的確認

```
例：
  - 玩家 A 在第一階段說：「玩家 B 是我的堂兄」
  - 玩家 B 在第一階段說：「玩家 A 是我的叔叔」
  → 兩個說法不一致（堂兄應該是對稱的），檢測到衝突
     標記為 `conflict_type: relationship_inconsistency`
```

#### 衝突類型 3：邏輯衝突

**定義**：派生出的邏輯衝突

```
例：
  - 玩家 A 說：「玩家 B 是我的兒子」
  - 玩家 B 說：「玩家 A 是我的兒子」
  → 邏輯矛盾，檢測到衝突，標記為 `conflict_type: logical_contradiction`
```

### 步驟 2：衝突優先級評估

對所有檢測到的衝突進行優先級評估：

| 優先級 | 衝突類型                     | 說明                     | 處理方式         |
| ------ | ---------------------------- | ------------------------ | ---------------- |
| 高     | 邏輯矛盾                     | 違反基本邏輯，必須解決   | 人工審核         |
| 高     | 關係衝突（玩家間的「是誰」） | 影響族譜結構，必須確定   | 人工審核         |
| 中     | 屬性衝突（性別）             | 影響邏輯驗證與視覺呈現   | 多數決或人工審核 |
| 中     | 屬性衝突（年齡大小關係）     | 影響排序，但不影響連通性 | 多數決或人工審核 |
| 低     | 屬性衝突（生日日期）         | 非必需資訊，多數決       | 多數決           |
| 低     | 名字變種                     | 可能同一人的不同寫法     | 標記為「同人」   |

### 步驟 3：自動衝突解決與人工標記

系統根據衝突優先級進行自動或標記人工：

#### 自動解決規則

**多數決規則**：同一屬性有多個答案時，選擇**最多人給出的答案**

```
例：「爺爺的生日」
  - 玩家 A、B、C 填寫：1950-01-01
  - 玩家 D 填寫：1950-01-02
  → 自動採用：1950-01-01（3 票 > 1 票）
```

**可信度加權規則**：根據玩家與節點的關係遠近進行加權

```
例：「叔叔的性別」（節點是玩家 A 的叔叔）
  - 玩家 A 填寫：男性（關係最近，權重 × 2）
  - 玩家 B、C 填寫：女性（關係遠，權重 × 1）
  → 加權投票：男性 2 票，女性 2 票
  → 優先採用玩家 A 的答案（權重更高）
```

**時間優先規則**：多人填寫相同屬性時，優先採用第一位填寫者的答案

```
例：「奶奶的名字」
  - 玩家 A (時間 0:30) 填寫：王李氏
  - 玩家 B (時間 1:45) 填寫：王李氏
  - 玩家 C (時間 2:10) 填寫：李王氏
  → 自動採用玩家 A 的答案（最早填寫）
```

#### 人工標記規則

**無法自動解決的衝突**進行人工標記：

```json
{
  "conflict_id": "conflict_20260224_001",
  "node_id": "virtual_grandfather_A",
  "conflict_type": "relationship_inconsistency",
  "severity": "high",
  "descriptions": ["玩家 A 說玩家 B 是他的堂兄", "玩家 B 說玩家 A 是他的叔叔"],
  "requires_manual_review": true,
  "status": "pending_review",
  "marked_at": "2026-02-24T10:30:00Z"
}
```

### 步驟 4：完整性驗證

確認是否滿足 MVFT 完成標準：

✓ **檢查 1**：所有玩家都有父親與母親虛擬節點 → 檢查是否為空或衝突標記

✓ **檢查 2**：所有父母節點都有姓名與性別 → 檢查缺失值或衝突

✓ **檢查 3**：所有在第一階段確認有關係的玩家都在同一棵族譜樹上 → 檢查連通性

✓ **檢查 4**：沒有未解決的「路徑衝突」 → 檢查是否存在需要人工審核的衝突

**驗證結果**：

- `mvft_completed: true/false`
- `verification_warnings: [list of unsolved issues]`

### 步驟 5：關係一致性檢查

驗證所有確認的關係是否邏輯一致：

```
檢查邏輯：
  如果 A → B (父子關係)，則：
    ✓ A.age > B.age （父親應該比兒子年長）
    ✓ B.father == A （兒子的父親應該是 A）
    ✓ A.children 包含 B （父親的子女應該包含兒子）

若違反邏輯，標記為衝突並入人工審核隊列
```

---

## 🎬 揭曉動畫

### 動畫序列

#### 階段 3.1：畫面轉換（0-1 秒）

```
當時間耗盡，遊戲立即暫停
UI 逐漸淡出（fade out）所有問題卡片
背景漸變為「族譜展示」模式（顏色變淡、聚焦中央）
```

#### 階段 3.2：登場動畫（1-3 秒）

```
從現場玩家節點開始，逐漸「點亮」：
  - 第 0 層：所有玩家節點同時點亮（綠色光暈，伸縮 1.5 倍）
  - 第 1 層：父母節點逐個點亮（0.5 秒間隔），伴隨連線動畫
  - 第 2 層：祖父母與配偶節點逐個點亮
  - 第 3 層：更上層與旁系親屬逐個點亮

視覺效果：
  - 每個新點亮的節點伴隨「漣漪」動畫（向外擴散的光波）
  - 連線從父到子逐條繪製（路徑動畫，線條漸變而不是突現）
  - 背景音：溫暖的弦樂及家族合奏聲（可選）
```

#### 階段 3.3：完整族譜展示（3-5 秒）

```
族譜完全展開，呈現以下信息：
  - 所有節點位置最終定位（已完成布局演算法）
  - 每個節點顯示：姓名、性別圖示、出生年份（如有）
  - 連線以不同顏色區分：
    * 紅線：血緣關係（父子）
    * 橙線：配偶關係
    * 虛線：待確認的關係
    * 灰線：有衝突標記的關係

玩家視角：
  - 整個家族樹從無到有地「生長」在眼前
  - 可以看到自己在族譜中的位置及與他人的關係
  - 驚喜與感動（家族連接的視覺化）
```

#### 階段 3.4：過渡到結果頁面（5-6 秒）

```
族譜保持在屏幕中央，逐漸收縮至左側（留出空間顯示結果）
右側漸漸顯示計分板與排名（從透明逐漸顯示）
完整的結果頁面呈現
```

---

## 📊 計分系統詳解

### 計分項目與積分

| 項目                     | 積分 | 說明                                         |
| ------------------------ | ---- | -------------------------------------------- |
| 回答關係問題（第一階段） | +1   | 每個正確回答的關係問題                       |
| 節點命名                 | +1   | 為虛擬節點命名                               |
| 屬性填充（生日/年齡）    | +1   | 填寫一項屬性                                 |
| 向上追溯                 | +1.5 | 向上追溯至更高層的親屬（關鍵任務，積分更高） |
| 節點匯聚確認             | +2   | 確認兩條路徑指向同一人（最高積分項）         |
| 排序確認                 | +0.5 | 確認兩人年齡大小關係（輔助項目，積分最低）   |

### 權重與修飾符

#### 首次填寫獎勵

**規則**：同一個節點的同一個信息，首位填寫者獲得**完整積分**，後續填寫者獲得**5% 積分**（確認獎）

```
例：「爺爺的生日」
  - 玩家 A (首次填寫)：獲得 +1 分
  - 玩家 B (確認填寫)：獲得 +0.05 分
  - 玩家 C (確認填寫)：獲得 +0.05 分
```

#### 準確性加成

**規則**：若填寫的信息與多數人意見一致，獲得**加成獎勵**

```
例：「奶奶的生日」
  - 填寫 1950-01-01 的玩家：獲得 +1 × 1.2 = +1.2 分（加成 20%）
  - 填寫 1950-01-02 的玩家：獲得 +1 × 0.5 = +0.5 分（減成 50%）
  - 填寫 1950-01-03 的玩家：獲得 +1 × 0.5 = +0.5 分（減成 50%）
```

#### 衝突項減分

**規則**：若填寫的信息被标记为「衝突」但最终采用，暂不扣分；若被驳回，**扣除原應獲得的積分的 50%**

```
例：「叔叔的性別」有衝突（玩家 A 說男性，玩家 B 說女性）
  - 若最终采用玩家 A 的「男性」：
    玩家 A 獲得 +1 分（無扣分）
    玩家 B 扣除 -0.5 分（懲罰不準確的答案）
```

### 積分計算示例

```
玩家 A 的積分計算：

活動記錄：
1. 第一階段：回答「玩家 B 是我的堂兄」→ +1 分
2. 第二階段：填寫「爺爺的名字」（首次）→ +1 分
3. 第二階段：填寫「爺爺的生日」（確認）→ +0.05 分
4. 第二階段：向上追溯「祖父的父親是誰」→ +1.5 分
5. 第二階段：確認「叔叔是王金剛」（節點匯聚）→ +2 分
6. 第二階段：確認「爺爺正確的生日（大多數一致）」→ +1.2 分（加成）
7. 第二階段：排序「爺爺 vs 奶奶年齡」→ +0.5 分

總積分：1 + 1 + 0.05 + 1.5 + 2 + 1.2 + 0.5 = 7.25 分
```

### 排名機制

#### 排名決定

```
1. 按「總積分」從高到低排序
2. 積分相同時，按「任務完成數」（填寫答案數）排序
3. 若仍相同，按「平均積分/任務」排序（效率排序）
```

#### 特殊獎項

**MVP（Most Valuable Player）**：總積分最高的玩家

```
獎勵：
  - 特殊標誌：👑 或 ⭐
  - 額外榮譽：「最佳貢獻者」
  - 可選遊戲獎勵：解鎖成就、積分加 10% 等
```

**效率王**：平均每個任務擁有最高積分（效率最高）

```
計算：
  平均積分 = 總積分 / 完成任務數

例：
  玩家 A：7.25 分 / 7 任 ≈ 1.04 分/任
  玩家 B：8.5 分 / 12 任 ≈ 0.71 分/任
  → 效率王是玩家 A
```

**團隊英雄**：協作獎（任務分散度最高，幫助多個領域）

```
計算：
  - 參與任務類型的多樣性
  - 幫助他人（通過確認填寫）的次數

若某玩家在所有任務類型都有貢獻，即為團隊英雄
```

---

## 📈 結果呈現

結果頁面顯示以下內容：

### 元素 1：族譜完整度卡片

```
┌─────────────────────────────────┐
│     族譜完整度                    │
├─────────────────────────────────┤
│ 總節點數：24                      │
│ 已填寫名字：22                    │
│ 已填寫生日：18                    │
│ 完整度：88%                       │
│                                  │
│ [進度條視覺化]                    │
│ ████████████████░░░░             │
└─────────────────────────────────┘
```

### 元素 2：個人貢獻卡片

```
┌─────────────────────────────────┐
│  玩家 A (你)                      │
├─────────────────────────────────┤
│ 總積分：7.25 分                   │
│ 排名：2 / 5                       │
│ 完成任務：7 個                    │
│                                  │
│ 貢獻項目：                        │
│  • 回答關係：1                    │
│  • 節點命名：2                    │
│  • 屬性填充：4                    │
│  • 節點匯聚：1                    │
│                                  │
│ 獲得獎項：「效率王」⭐            │
└─────────────────────────────────┘
```

### 元素 3：排行榜

```
┌─────────────────────────────────┐
│        排行榜 (5 人遊戲)          │
├──┬────────────┬────────┬──────┤
│排│   玩家     │  積分  │ 獎項 │
├──┼────────────┼────────┼──────┤
│🥇│ 玩家 D    │ 9.5   │ MVP  │
│🥈│ 玩家 A    │ 7.25  │ ⭐  │
│🥉│ 玩家 B    │ 6.8   │      │
│ 4│ 玩家 C    │ 5.2   │      │
│ 5│ 玩家 E    │ 4.0   │      │
└──┴────────────┴────────┴──────┘
```

### 元素 4：族譜視覺化

```
完整的、著色的族譜樹展示在中央或左側
  - 玩家節點：綠色，較大
  - 虛擬節點：灰色，較小
  - 衝突節點：紅色邊框（可選點擊查看衝突詳情）
  - 確認節點：金色邊框
```

### 元素 5：分享與保存選項

```
[分享族譜] 按鈕 → 生成可分享的族譜圖片 (JPG/PNG)
[下載資料] 按鈕 → 下載 JSON 或 CSV 格式的族譜數據
[返回大廳] 按鈕 → 返回房間，等待下一局
```

---

## 🎯 特殊情況與異常處理

### 情況 1：多族譜分支（不連通）

**現象**：若所有玩家之間都互相「完全不知道」，可能產生多個獨立的族譜分支

**顯示方式**：

```
族譜頁面顯示多棵樹：
  [分支 1：玩家 A、B、C 的族譜樹]
  [分支 2：玩家 D、E 的族譜樹]

說明文字：「遊戲發現 2 個獨立的家族分支」
```

**計分影響**：無影響，按正常計分規則

### 情況 2：所有玩家都是同輩（無法確認上代）

**現象**：玩家都無法填寫上代信息，族譜只有「現場玩家層」

**顯示方式**：

```
族譜顯示：
  - 中央：5 個玩家節點（同層排列）
  - 上層：虛擬節點「父親」與「母親」
  - 無更上層延伸

提示文字：「這組玩家的上代信息無法充分確認」
```

**計分影響**：無影響，系統正常計分

### 情況 3：完整族譜無法閉合的情況

**現象**：某些玩家無法透過虛擬節點連接到其他玩家（MVFT 未達成）

**警告顯示**：

```
[⚠️ 族譜不完整]

無法確認的關係：
  • 玩家 A 與 B 的連接路徑
  • 玩家 C 的上代信息

原因可能：
  1. 玩家間完全不知道彼此
  2. 信息數量不足以構建路徑
  3. 存在未解決的衝突
```

**計分影響**：

- 已填寫的部分正常計分
- 無法填寫的部分不被懲罰
- 可獲得「努力獎」：在不完整的信息下還是盡力貢獻

### 情況 4：高衝突情況（多個衝突無法自動解決）

**現象**：多於 5 個高優先級衝突無法自動解決

**警告顯示**：

```
[⚠️ 資料驗證警告]

檢測到 8 個衝突：
  • 7 個中優先級（屬性衝突）
  • 1 個高優先級（關係衝突 - 需人工審核）

族譜暫時以「最佳猜測」方式呈現
部分關係可能存在不準確
```

**顯示方式**：衝突節點用紅色邊框標記，可點擊查看詳情

**計分影響**：無直接影響，衝突由人工審核後最終確認

### 情況 5：旁觀者進入時遊戲已進行

**現象**：玩家在遊戲進行中加入，自動成為旁觀者

**顯示方式**：

```
旁觀者頁面：
  - 可查看其他玩家正在回答的問題類型（不顯示具體問題）
  - 即時統計：目前填寫的節點數、進度百分比
  - 最終可查看結果與排行榜，但不出現在排行榜上
```

**計分影響**：旁觀者無積分，不出現排行榜

---

## 💾 階段三完成與數據保存

### 數據持久化

所有生成的族譜數據存儲為：

```json
{
  "game_session": {
    "room_id": "room_12345",
    "game_id": "game_20260224_001",
    "timestamp": "2026-02-24T10:45:00Z",
    "duration_seconds": 120,
    "player_count": 5
  },
  "family_tree": {
    "nodes": [...],
    "edges": [...],
    "metadata": {...}
  },
  "results": {
    "scores": [...],
    "ranking": [...],
    "mvft_status": true,
    "conflicts": [...]
  }
}
```

### 回顧與分享

玩家可以：

- 📸 截圖或下載族譜圖片
- 📊 導出數據（CSV/JSON）進行個人保存
- 🔗 生成分享連結（可讓他人查看該遊戲的族譜，但無法修改）
- 💾 保存至個人帳號（如有帳號系統）

---

## 📋 遊戲結束後

### 玩家操作

✅ **查看完整族譜**：首次能看到完整的族譜結構

✅ **檢視個人貢獻**：詳細查看自己的每項貢獻與積分

✅ **檢視衝突詳情**：點擊衝突節點，查看不同玩家的答案

✅ **分享與導出**：分享族譜圖片或導出數據

✅ **返回大廳**：準備進行下一局遊戲

❌ **修改答案**：遊戲結束後無法修改已提交的答案

❌ **切換房間**：必須返回大廳，無法在結果頁面切換房間

---

## 特殊功能：衝突詳情查看

玩家可點擊任何標記為「衝突」的節點，查看詳細的衝突信息：

```
┌─────────────────────────────────┐
│    衝突詳情：「爺爺的生日」       │
├─────────────────────────────────┤
│ 衝突類型：屬性衝突（生日不一致）  │
│                                  │
│ 不同答案：                        │
│  玩家 A：1950-01-01              │
│  玩家 C：1950-01-02              │
│  玩家 E：1950-01-01              │
│                                  │
│ 最終採用：1950-01-01            │
│ 採用原因：多數決（2 票 vs 1 票）   │
│                                  │
│ [關閉] 按鈕                       │
└─────────────────────────────────┘
```
