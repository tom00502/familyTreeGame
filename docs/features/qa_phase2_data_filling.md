# 階段 2：資料填充 (Data Completion)

## 📌 階段概述

**目標**：填補虛擬節點的詳細資訊，完成最小可行族譜 (MVFT)

**玩家體驗**：持續回答「虛擬節點資訊」的各種題目（姓名、性別、生日、親屬確認等），但無法看到完整族譜結構。玩家回答的每個問題都獨立且互不相關，不知道這些答案如何拼湊成族譜

**系統目標**：利用玩家的分散答案，透過「獲取或建立」(Get or Create) 邏輯逐步構建完整的虛擬節點家族樹

---

## 🎯 最小可行族譜 (MVFT) 概述

本階段的目標是透過資料填充完成**最小可行族譜 (MVFT)**。

✅ **MVFT 的詳細定義、核心概念與完成標準** → 請查閱 [concepts/mvft.md](../concepts/mvft.md)

本文件專注於資料填充階段的**策略與實作**，包括任務類型、派發算法、問題模板等。

---

## � 核心術語定義

### 骨架族譜 (Skeleton MVFT)

**定義**：族譜圖在「階段一：關係確認」結束後產出的中間態邏輯模型。具備完整的圖論結構與邏輯一致性，但節點資料主要由虛擬節點構成。

**特徵**：

| 面向                              | 狀態      |
| --------------------------------- | --------- |
| 結構完整性 (Structural Integrity) | ✅ 完整   |
| 資料完整性 (Data Integrity)       | ❌ 不完整 |

**組成元素**：

- **玩家節點** (`isVirtual: false, isPlayer: true`)：房間內真實連線的玩家
- **虛擬關鍵節點** (`isVirtual: true, isKeyNode: true`)：位於關鍵路徑上，連結玩家的祖先或中間人
- **預製邊 (Prefab Edges)**：基於稱謐解析出的邏輯關係線，待名稱與順序填寫

**作用**：作為「關係連連看」（階段一）與「資料搶答」（階段二）之間的橋樑，定義「哪些資訊是必須填寫的」。

---

## �📝 資料填充任務系統

### 概述

資料填充階段透過五類任務類型的組合，逐步實體化虛擬節點並完成 MVFT。各任務透過**優先級分級系統**與**獨佔提問機制**進行派發，確保效率與資料準確性。

---

## 📝 五類任務類型

### 任務類型 1：節點命名 (Node Naming)

**觸發條件**：虛擬節點存在但姓名為空

**提問模板**：

```
「你的 {node_label} 叫什麼名字？」
「請問{node_name}的父親叫什麼名字？」
「有人記得這位{node_label}的名字嗎？」
```

**玩家操作**：

- 輸入 2-20 個中文字元的姓名
- 可選擇「不知道」（任務重新分派）
- 可選擇「跳過」（任務延後）

**計分**：完成此任務獲得 1 分

---

### 任務類型 2：屬性填充 (Attribute Filling)

**觸發條件**：節點已有姓名，但缺少性別、生日或年齡資訊

**提問模板**：

```
「{node_name}是男性還是女性？」
「有人記得{node_name}的生日或大約幾歲嗎？」
「{node_name}大約是幾年出生？」
```

**玩家操作**：

- 性別：二選一（男性/女性）或「不知道」
- 生日：輸入 YYYY/MM/DD 或「不知道」
- 年齡：輸入數字或「不知道」

**計分**：完成此任務獲得 1 分

---

### 任務類型 3：向上追溯 (Upward Tracing)

**觸發條件**：當前節點是關鍵路徑上的節點，但其父親或母親為空

**提問模板**：

```
「{node_name}的父親是誰？」
「{node_name}的母親叫什麼名字？」
「有人知道{node_name}大概的上輩是誰嗎？」
```

**玩家操作**：

- 若知情：輸入虛擬節點該祖代親戚的名字，或確認已有的名字
- 若不知道：選擇「不知道」
- 若涉及多個可能的答案：選擇「不確定」（標記為待確認）

**計分**：完成此任務獲得 1.5 分（相比其他任務更高，因為此任務涉及路徑閉合）

---

### 任務類型 4：節點匯聚 (Node Convergence)

**觸發條件**：系統偵測到兩條不同路徑可能指向同一個人

**提問模板**：

```
「玩家 B，你的{node_label}是『{known_name}』嗎？」
「{node_A}和{node_B}是同一個人嗎？」
```

**背景**：

- 不同玩家可能從不同途徑提到同一個人的名字
- 或系統根據親屬關係推導出兩條路徑應該匯聚
- 此任務確認這兩條路徑是否指向同一人

**玩家操作**：

- 是／否 選擇
- 或「不確定」（標記為待確認）

**計分**：完成此任務獲得 2 分（此任務最高分，因為關鍵到族譜的正確性）

---

### 任務類型 5：排序確認 (Age Ordering)

**觸發條件**：系統需要確認多個同輩或相鄰代數的節點之間的年齡大小關係

**提問模板**：

```
「{node_A}與{node_B}誰的年紀比較大？」
「按出生順序，下列人誰最年長？{list}」
```

**玩家操作**：

- 選擇更年長者
- 若無法判斷：選擇「不知道」

**計分**：完成此任務獲得 0.5 分（輔助任務，計分最低）

---

## 🎯 任務派發策略

### 優先級分級系統

系統使用**多維度評分模型**決定將哪個任務分派給哪位玩家。

| 優先級 | 任務類型             | 目標                     | 權重 | 例子                         |
| ------ | -------------------- | ------------------------ | ---- | ---------------------------- |
| 1      | 向上追溯 + 節點命名  | 路徑閉合                 | 100% | 填寫玩家父母、祖父母資訊     |
| 2      | 節點匯聚             | 確認多路徑的匯聚點       | 80%  | 確認「爺爺」是否為「王金剛」 |
| 3      | 屬性填充（關鍵路徑） | 補齊關鍵路徑上的詳細資訊 | 60%  | 填寫父親的生日               |
| 4      | 節點命名（旁系）     | 擴張旁系親屬資訊         | 40%  | 填寫伯父、堂兄弟的名字       |
| 5      | 排序確認             | 邏輯驗證與視覺排序       | 30%  | 確認叔叔與父親誰更年長       |
| 6      | 屬性填充（旁系）     | 補充選擇資訊             | 20%  | 填寫堂弟的生日               |

### 派發算法規則

#### 規則 1：關係親近優先

任務優先派發給與該節點**關係最近**的玩家：

```
例：需要填寫「玩家 A 的祖父」的姓名

派發優先級：
  1️⃣ 玩家 A 本身（親近度最高）
  2️⃣ 玩家 A 的父親（如果在遊戲中）
  3️⃣ 玩家 A 的兄弟姊妹（玩家）
  4️⃣ 玩家 A 的堂兄弟（玩家）
  5️⃣ 任何其他玩家（親近度最低）
```

#### 規則 2：獨佔提問 (Exclusive Quizzing)

**核心機制**：同一個任務在同一時刻**只派發給一位玩家**

**詳細邏輯**：

1. **單一派發**
   - 系統將任務 T 分派給玩家 P（根據上述優先級算法選出）
   - 只有玩家 P 在其螢幕上看到任務 T
   - 該任務從其他玩家的潛在題目池中移除

2. **鎖定機制**
   - 玩家 P 開始輸入時，系統發送 `task_lock` 事件
   - 其他玩家收到通知：「{玩家名} 正在填寫該資訊」
   - 任務從其他玩家的潛在題目池中移除
   - 其他玩家無法提交關於此任務的答案

3. **任務流轉**
   - **完成**：玩家 P 提交答案 → 任務完成，累積分數
   - **跳過**：玩家 P 選擇「跳過」 → 任務優先級降低，重新分派給其他玩家
   - **超時未動作**：超過時間限制 → 自動作為「跳過」處理

4. **狀態轉換圖**

```
未分派
  ↓
[分派給玩家A]
  ↓
已分派 ← [玩家A看到任務]
  ↓
  ├─→ [玩家A開始輸入] → 鎖定中 ↘
  │                          ├─→ [提交] → 完成（移出）
  │                          └─→ [跳過] → 優先級↓，重新分派
  │
  └─→ [超時] → 優先級↓，重新分派
```

#### 規則 3：跳過流轉與優先級衰減

玩家跳過或超時後，系統將任務**重新進入任務池**：

```
初始派發：玩家A → [跳過] → 玩家B
玩家B完成或跳過：玩家B → [跳過] → 玩家C
依次流轉，直到完成或時間耗盡
```

**優先級衰減**：

- 每被跳過一次，優先級分數 × 0.8（衰減 20%）
- 被跳過 5 次或以上的任務，自動降至最低優先級

---

## 🔗 稱謂與路徑對應表 (Kinship Mapping)

### KinshipMap 節點與邊定義

本表基於 [kinshipMap.json](/public/kinshipMap.json)，展示每個節點的稱謂 Key、性別、標題與邊定義（含五等親）。用於校對邊類型與目標節點是否正確。

| 節點 Key                       | 性別 | 稱謂 (Male / Female) | Edges 類型 | Target 節點            | 說明                     |
| ------------------------------ | ---- | -------------------- | ---------- | ---------------------- | ------------------------ |
| **self**                       | any  | (自己)               | P_f        | father                 | 向上 → 父親              |
|                                |      |                      | P_m        | mother                 | 向上 → 母親              |
|                                |      |                      | S          | spouse                 | 水平 → 配偶              |
|                                |      |                      | C_m        | son                    | 向下 → 兒子              |
|                                |      |                      | C_f        | daughter               | 向下 → 女兒              |
| **father**                     | M    | (爸爸)               | P_f        | paternal_grandfather   | 向上 → 祖父(父側)        |
|                                |      |                      | P_m        | paternal_grandmother   | 向上 → 祖母(父側)        |
|                                |      |                      | S          | mother                 | 水平 → 配偶(母親)        |
|                                |      |                      | C_any      | self                   | 向下 → 子女(自己)        |
|                                |      |                      | C_any      | sibling                | 向下 → 子女(兄弟/姊妹)   |
| **mother**                     | F    | (媽媽)               | P_f        | maternal_grandfather   | 向上 → 祖父(母側)        |
|                                |      |                      | P_m        | maternal_grandmother   | 向上 → 祖母(母側)        |
|                                |      |                      | S          | father                 | 水平 → 配偶(父親)        |
|                                |      |                      | C_any      | self                   | 向下 → 子女(自己)        |
|                                |      |                      | C_any      | sibling                | 向下 → 子女(兄弟/姊妹)   |
| **son**                        | M    | (兒子)               | P_f        | (father - 自己的父親)  | 向上 → 父親              |
|                                |      |                      | P_m        | (mother - 自己的母親)  | 向上 → 母親              |
|                                |      |                      | S          | (配偶 - 媳婦)          | 水平 → 配偶              |
|                                |      |                      | C_any      | (孫子/孫女)            | 向下 → 子女              |
| **daughter**                   | F    | (女兒)               | P_f        | (father - 自己的父親)  | 向上 → 父親              |
|                                |      |                      | P_m        | (mother - 自己的母親)  | 向上 → 母親              |
|                                |      |                      | S          | (配偶 - 女婿)          | 水平 → 配偶              |
|                                |      |                      | C_any      | (孫子/孫女)            | 向下 → 子女              |
| **spouse**                     | M/F  | (配偶/伴侶)          | P_f        | (spouse 的父親)        | 向上 → 父親              |
|                                |      |                      | P_m        | (spouse 的母親)        | 向上 → 母親              |
|                                |      |                      | S          | self                   | 水平 → 配偶(回到自己)    |
|                                |      |                      | C_any      | (配偶的子女)           | 向下 → 配偶的子女        |
| **paternal_grandfather**       | M    | 祖父(父側)           | P_f        | 曾祖父(父側)           | 向上 → 曾祖父            |
|                                |      |                      | P_m        | 曾祖母(父側)           | 向上 → 曾祖母            |
|                                |      |                      | S          | paternal_grandmother   | 水平 → 配偶(祖母)        |
|                                |      |                      | C_any      | father                 | 向下 → 子女(父親)        |
|                                |      |                      | C_any      | paternal_uncle_aunt    | 向下 → 子女(叔伯/姑姑)   |
| **paternal_grandmother**       | F    | 祖母(父側)           | P_f        | 曾祖父(父側)           | 向上 → 曾祖父            |
|                                |      |                      | P_m        | 曾祖母(父側)           | 向上 → 曾祖母            |
|                                |      |                      | S          | paternal_grandfather   | 水平 → 配偶(祖父)        |
|                                |      |                      | C_any      | father                 | 向下 → 子女(父親)        |
|                                |      |                      | C_any      | paternal_uncle_aunt    | 向下 → 子女(叔伯/姑姑)   |
| **maternal_grandfather**       | M    | 祖父(母側)/外公      | P_f        | 曾祖父(母側)           | 向上 → 曾祖父            |
|                                |      |                      | P_m        | 曾祖母(母側)           | 向上 → 曾祖母            |
|                                |      |                      | S          | maternal_grandmother   | 水平 → 配偶(祖母/外婆)   |
|                                |      |                      | C_any      | mother                 | 向下 → 子女(母親)        |
|                                |      |                      | C_any      | maternal_uncle_aunt    | 向下 → 子女(舅舅/阿姨)   |
| **maternal_grandmother**       | F    | 祖母(母側)/外婆      | P_f        | 曾祖父(母側)           | 向上 → 曾祖父            |
|                                |      |                      | P_m        | 曾祖母(母側)           | 向上 → 曾祖母            |
|                                |      |                      | S          | maternal_grandfather   | 水平 → 配偶(祖父/外公)   |
|                                |      |                      | C_any      | mother                 | 向下 → 子女(母親)        |
|                                |      |                      | C_any      | maternal_uncle_aunt    | 向下 → 子女(舅舅/阿姨)   |
| **paternal_uncle_aunt**        | any  | 叔伯 / 姑姑          | P_f        | paternal_grandfather   | 向上 → 祖父(父側)        |
|                                |      |                      | P_m        | paternal_grandmother   | 向上 → 祖母(父側)        |
|                                |      |                      | S          | (配偶 - 嬸嬸/伯母等)   | 水平 → 配偶              |
|                                |      |                      | C_any      | paternal_cousin        | 向下 → 子女(堂兄弟/姊妹) |
| **sibling**                    | any  | 兄弟 / 姊妹          | P_f        | father                 | 向上 → 父親(共同父親)    |
|                                |      |                      | P_m        | mother                 | 向上 → 母親(共同母親)    |
|                                |      |                      | S          | sibling_spouse         | 水平 → 配偶(兄嫂/弟妹等) |
|                                |      |                      | C_any      | nephew_niece           | 向下 → 子女(姪子/姪女)   |
| **paternal_cousin**            | any  | 堂兄弟 / 堂姊妹      | P_any      | paternal_uncle_aunt    | 向上 → 父親(叔伯/姑姑)   |
|                                |      |                      | S          | (配偶 - 堂嫂/堂妹夫等) | 水平 → 配偶              |
|                                |      |                      | C_any      | (堂侄/堂姪)            | 向下 → 子女              |
| **maternal_uncle_aunt**        | any  | 舅舅 / 阿姨          | P_f        | maternal_grandfather   | 向上 → 祖父(母側)        |
|                                |      |                      | P_m        | maternal_grandmother   | 向上 → 祖母(母側)        |
|                                |      |                      | S          | (配偶 - 舅媽/阿姨夫等) | 水平 → 配偶              |
|                                |      |                      | C_any      | maternal_cousin        | 向下 → 子女(表兄弟/姊妹) |
| **maternal_cousin**            | any  | 表兄弟 / 表姊妹      | P_any      | maternal_uncle_aunt    | 向上 → 父親(舅舅/阿姨)   |
|                                |      |                      | S          | (配偶 - 表嫂/表妹夫等) | 水平 → 配偶              |
|                                |      |                      | C_any      | (表侄/表姪)            | 向下 → 子女              |
| **paternal_grandparents_unit** | any  | 祖父母(父側)聯合單位 | P_any      | 曾祖父母(父側)         | 向上 → 曾祖父母          |
|                                |      |                      | C_any      | father                 | 向下 → 子女(父親)        |
|                                |      |                      | C_any      | paternal_uncle_aunt    | 向下 → 子女(叔伯/姑姑)   |
| **maternal_grandparents_unit** | any  | 祖父母(母側)聯合單位 | P_any      | 曾祖父母(母側)         | 向上 → 曾祖父母          |
|                                |      |                      | C_any      | mother                 | 向下 → 子女(母親)        |
|                                |      |                      | C_any      | maternal_uncle_aunt    | 向下 → 子女(舅舅/阿姨)   |

### 路徑邏輯表（按親等分類至五等親）

此表展示從「自己」(self) 出發，透過邊序列到達各個親屬的邏輯路徑。

| 親等       | 節點Key              | 稱謂                  | 邊序列                          | 路徑說明                                                                              |
| ---------- | -------------------- | --------------------- | ------------------------------- | ------------------------------------------------------------------------------------- |
| **一等親** |
|            | father               | 父親                  | [P_f]                           | self → P_f → father                                                                   |
|            | mother               | 母親                  | [P_m]                           | self → P_m → mother                                                                   |
|            | son                  | 兒子                  | [C_m]                           | self → C_m → son                                                                      |
|            | daughter             | 女兒                  | [C_f]                           | self → C_f → daughter                                                                 |
|            | spouse               | 配偶                  | [S]                             | self → S → spouse                                                                     |
| **二等親** |
|            | paternal_grandfather | 祖父(父側)            | [P_f, P_f]                      | self → P_f → father → P_f → paternal_grandfather                                      |
|            | paternal_grandmother | 祖母(父側)            | [P_f, P_m]                      | self → P_f → father → P_m → paternal_grandmother                                      |
|            | maternal_grandfather | 祖父(母側)            | [P_m, P_f]                      | self → P_m → mother → P_f → maternal_grandfather                                      |
|            | maternal_grandmother | 祖母(母側)            | [P_m, P_m]                      | self → P_m → mother → P_m → maternal_grandmother                                      |
|            | 兄弟/姊妹            | 兄弟/姊妹             | [P_f, C_any (other)]            | self → P_f → father → C_any → 兄弟/姊妹 (父親的其他子女)                              |
| **三等親** |
|            | paternal_uncle_aunt  | 叔伯/姑姑             | [P_f, P_f, C_any]               | self → P_f → father → P_f → paternal_grandfather → C_any → paternal_uncle_aunt        |
|            | paternal_cousin      | 堂兄弟/姊妹           | [P_f, P_f, C_any, C_any]        | ... → paternal_grandfather → C_any → paternal_uncle_aunt → C_any → paternal_cousin    |
|            | maternal_uncle_aunt  | 舅舅/阿姨             | [P_m, P_f, C_any]               | self → P_m → mother → P_f → maternal_grandfather → C_any → maternal_uncle_aunt        |
|            | maternal_cousin      | 表兄弟/姊妹           | [P_m, P_f, C_any, C_any]        | ... → maternal_grandfather → C_any → maternal_uncle_aunt → C_any → maternal_cousin    |
|            | 侄子/姪女            | 侄子/姪女             | [C_m, C_any] / [C_f, C_any]     | self → C_m → son → C_any → 孫子/孫女 (或 self → C_f → daughter → C_any → 孫子/孫女)   |
|            | 媳婦/女婿            | 媳婦/女婿             | [C_m, S] / [C_f, S]             | self → C_m → son → S → 媳婦 (或 self → C_f → daughter → S → 女婿)                     |
| **四等親** |
|            | 曾祖父(父側)         | 曾祖父(父側)          | [P_f, P_f, P_f]                 | self → P_f → father → P_f → paternal_grandfather → P_f → 曾祖父                       |
|            | 曾祖母(父側)         | 曾祖母(父側)          | [P_f, P_f, P_m]                 | self → P_f → father → P_f → paternal_grandfather → P_m → 曾祖母                       |
|            | 曾祖父(母側)         | 曾祖父(母側)          | [P_m, P_f, P_f]                 | self → P_m → mother → P_f → maternal_grandfather → P_f → 曾祖父                       |
|            | 曾祖母(母側)         | 曾祖母(母側)          | [P_m, P_f, P_m]                 | self → P_m → mother → P_f → maternal_grandfather → P_m → 曾祖母                       |
|            | 曾孫/曾孫女          | 曾孫/曾孫女           | [C_m, C_any, C_any]             | self → C_m → son → C_any → 孫子/孫女 → C_any → 曾孫                                   |
|            | 堂伯/堂叔/堂姑       | 堂伯/堂叔/堂姑        | [P_f, P_f, P_any, C_any]        | ... → paternal_grandfather → P_f → 曾祖父 → C_any → 堂伯父/叔父/姑姑 (祖父的兄弟姊妹) |
|            | 堂兄堂弟的兒女       | 表姪/表甥女           | [P_f, P_f, C_any, C_any, C_any] | ... → paternal_cousin → C_any → 堂侄/堂姪                                             |
|            | 表伯/表叔/表姑       | 表伯/表叔/表姑        | [P_m, P_f, P_any, C_any]        | ... → maternal_grandfather → P_f → 曾祖父 → C_any → 表伯父/叔父/姑姑 (外公的兄弟姊妹) |
|            | 表兄表弟的兒女       | 表姪/表甥女           | [P_m, P_f, C_any, C_any, C_any] | ... → maternal_cousin → C_any → 表侄/表姪                                             |
| **五等親** |
|            | 族曾祖               | 族曾祖                | [P_f, P_f, P_f, P_f]            | 祖父的祖父 (向上四代)                                                                 |
|            | 族曾孫               | 族曾孫                | [C_m, C_any, C_any, C_any]      | 向下四代子孫                                                                          |
|            | 遠房表親             | 遠房表親              | 複雜序列(5+ 步)                 | 涉及多層旁系的遠親 (建議系統在此級限制處理)                                           |
|            | 配偶的親屬           | 婆婆/公公/岳母/岳父等 | [S, P_f/P_m]                    | self → S → spouse → P_f → spouse 的父親 (婆婆/岳父)                                   |

---

### 核心概念：「獲取或建立」邏輯

此邏輯是系統的「生長引擎」，將抽象稱謝轉化為圖形結構：

```
當玩家說「A 是我的堂兄」時：
  系統解析路徑：A → P(男) → P(男) → C(男) → 我
  沿路徑走訪：
    1. 檢查是否有「我的父親」節點 → 若無則建立（虛擬）
    2. 檢查是否有「我的祖父」節點 → 若無則建立（虛擬）
    3. 檢查是否有「祖父的兒子（我的伯叔）」節點 → 若無則建立（虛擬）
    4. 確認此伯叔是否有兒子 → 若無則建立
  最終：A 與「伯叔的兒子」匹配 → 關係確認
```

### 原子動作定義

系統的三個基本方向動作（Atomic Operations）：

| 動作 | 符號 | 含義           | 例子                  |
| ---- | ---- | -------------- | --------------------- |
| 向上 | P    | Parent（往上） | P = 父親，P² = 祖父   |
| 向下 | C    | Child（往下）  | C = 兒子，C² = 孫子   |
| 水平 | S    | Spouse（配偶） | S = 配偶（丈夫/妻子） |

### 路徑解析範例表

| 稱謝   | 方向 | 路徑                    | 說明                     |
| ------ | ---- | ----------------------- | ------------------------ |
| 爸爸   | 父系 | P                       | 直接向上一代             |
| 爺爺   | 父系 | P²                      | 向上兩代，父親的父親     |
| 曾祖父 | 父系 | P³                      | 向上三代                 |
| 伯父   | 父系 | P(兄) = P.Sibling(男)   | 父親的男性兄長           |
| 叔叔   | 父系 | P(弟) = P.Sibling(男,Y) | 父親的男性幼弟           |
| 堂兄   | 父系 | P.P.C(男,O) = P².C(男)  | 祖父的子女的男性長子     |
| 表兄   | 母系 | M.P.C(男,O) = M.P².C    | 母親之父的子女的男性長子 |
| 兒子   | 子女 | C                       | 直接向下一代             |
| 孫子   | 子女 | C²                      | 向下兩代                 |
| 配偶   | 配偶 | S                       | 水平方向，配偶本人       |
| 媳婦   | 配偶 | C.S                     | 兒子的配偶               |
| 女婿   | 配偶 | C(女).S                 | 女兒的配偶               |

**註**：路徑符號的通用規則

- `P` = 父親或母親（由方向確定）
- `M` = 母親（特別標記時）
- `C(gender, order)` = 子女，可指定性別與出生順序
- `.` = 路徑連接符
- `Sibling(gender)` = 兄弟姊妹，可過濾性別

---

## 📊 提問問題模板表

此表為系統自動生成自然語言提問的範本：

| 任務類型 | 觸發時機                   | 提問模板                                                     | 例子                                       |
| -------- | -------------------------- | ------------------------------------------------------------ | ------------------------------------------ |
| 節點命名 | 虛擬節點姓名為空           | 「你的{node_label}叫什麼名字？」                             | 「你的爸爸叫什麼名字？」                   |
|          | 已有稱謝，需要詢問其他玩家 | 「{other_player}，你的{node_label}呢？」                     | 「王小明，你的爺爺叫什麼名字？」           |
| 屬性填充 | 已有姓名，生日為空         | 「有人記得{node_name}的生日嗎？」                            | 「有人記得王大明的生日嗎？」               |
|          | 已有姓名，年齡為空         | 「{node_name}大約幾歲？」                                    | 「王大明大約幾歲？」                       |
|          | 需要確認性別               | 「{node_name}是男性還是女性？」                              | 「王大明是男性還是女性？」                 |
| 向上追溯 | 需要建立更高階節點         | 「請問{node_name}的父親是誰？」                              | 「請問王大明的父親是誰？」                 |
|          | 需要追溯母親               | 「{node_name}的母親叫什麼名字？」                            | 「王大明的母親叫什麼名字？」               |
|          | 通用追溯提問               | 「有人知道{node_name}的上輩是誰嗎？」                        | 「有人知道王大明的上輩是誰嗎？」           |
| 節點匯聚 | 確認兩個不同名字是否同一人 | 「{player_name}，你的{node_label}是{known_name}嗎？」        | 「玩家王二，你的爺爺是『王金剛』嗎？」     |
|          | 確認姓名的多種寫法         | 「『{name_variant_1}』和『{name_variant_2}』是同一個人嗎？」 | 「『王大明』和『大明』是同一個人嗎？」     |
| 排序確認 | 確認兩個人的年齡大小       | 「{node_A}和{node_B}誰的年紀比較大？」                       | 「王金剛和李小華誰的年紀比較大？」         |
|          | 多人排序                   | 「按年齡大小排序：{node_list}」                              | 「按年齡大小排序：王大明、王中明、王小明」 |

---

## 🔄 系統實作邏輯流程

### 流程 1：路徑實體化 (Instantiation)

系統掃描第一階段結果，根據「稱謝路徑表」自動建立虛擬節點：

```
輸入：第一階段結果
  - 玩家 A: 玩家 B 是我的堂兄
  - 玩家 C: 玩家 B 是我的表兄

過程：
  1. 解析「堂兄」路徑：P².C → 需要 A 的祖父級節點
  2. 解析「表兄」路徑：M.P².C → 需要 C 的祖父級節點（母親那邊）
  3. 檢查虛擬節點集合，不存在則建立：
     - 虛擬節點「A 的祖父」
     - 虛擬節點「A 的祖父的兒子（伯叔）」
     - 虛擬節點「C 的外公」（母親的父親）
     - 虛擬節點「C 的外公的兒子（舅舅）」
  4. 標記「A 是虛擬節點『伯叔』的兒子」
  5. 標記「B 是虛擬節點『伯叔』的兒子」

輸出：
  - 新虛擬節點列表
  - 路徑實體化完成，準備進入任務分派
```

### 流程 2：任務分派 (Dispatching)

根據優先級算法，將「命名」與「追溯」任務丟入 Task Queue：

```
入隊任務（優先級排序）：
  1. 命名「A 的祖父」(優先級: 100, 派發給：A)
  2. 命名「A 的祖母」(優先級: 100, 派發給：A)
  3. 追溯「祖父的兒子」(優先級: 90, 派發給：A 或 C)
  4. 命名「外公」(優先級: 100, 派發給：C)
  ...
```

### 流程 3：節點去重與匯聚 (Deduplication)

當不同玩家提到同一個名字或透過匯聚問題確認身分後，系統合併節點 ID：

```
示例：
  - A 說「我的堂兄是王二明」
  - B 說「B 的舅舅是王二明」
  → 系統自動匯聚：「王大明」= 「王二明」（可能同一人）
  → 詢問相關玩家確認
  → 一旦確認，合併兩個虛擬節點 ID
```

**去重規則**：

- 同名同姓 → 透過年齡或配偶資訊進行二次確認
- 名字變種（「大明」 vs「王大明」）→ 記錄為疑似同一人，待確認
- 衝突資訊（同一人不同年齡）→ 標記為「衝突」，移交第三階段處理

### 流程 4：動態更新

一旦節點有了新資訊，所有相關問題自動更新：

```
初始問題（節點暫無姓名）：
  「你的父親叫什麼名字？」

玩家填寫後：
  「你的父親叫『王大明』，他的生日是？」

再填寫性別後：
  「王大明（男性）是你的父親，請確認他的生日...」

實時影響其他問題：
  節點匯聚問題自動更新：
    「玩家 B，你的爺爺是『王金剛』嗎？」（之前展示的是虛擬節點 ID）
```

---

## ⚠️ 邊界情況處理

### 情況 1：多重婚姻與複雜關係

**現狀**：MVP 暫不處理再婚或領養，以一夫一妻制的直系血親為主

**處理方式**：

- 系統假設每位玩家有唯一的父親與母親（虛擬節點）
- 若玩家間關係涉及再婚（如「我是同父異母的兄弟」），暫時記錄為「待確認」狀態
- 在階段三進行人工審核或特殊標記

### 情況 2：同名同姓誤判

**現象**：家族中有兩位「王小明」，系統可能誤判

**處理方式**：

- 系統自動進行二次確認：詢問「王小明」的年齡、配偶名字等額外信息
- 若仍無法區分，標記為「疑似同一人」，移交第三階段人工處理
- 結果儲存為：`node_merge_candidates: [node_id_1, node_id_2]`

### 情況 3：衝突標記

**現象**：玩家 A 與 B 對同一虛擬節點的資訊（如生日）回答不一致

**處理方式**：

- 系統**不應卡住**，繼續進行遊戲
- 將衝突標記為：`conflict: { node_id: xxx, field: 'birthday', values: ['1980-01-01', '1980-01-02'], sources: [playerA, playerB] }`
- 轉交至第三階段驗證與人工處理

---

## 💾 階段二完成條件

**系統定義**（由後端自動判定）：

1. ✓ 所有關鍵路徑上的玩家節點都有父親與母親虛擬節點
2. ✓ 所有父母節點都有姓名與性別
3. ✓ 所有在第一階段確認有關係的玩家都在同一棵族譜樹上（連通性滿足）
4. ✓ 沒有未解決的「路徑衝突」（例如同一玩家指向兩個不同的祖父）

**玩家感知**（由前端判定）：

❓ 玩家**無法感知**階段二何時完成

- 系統繼續派發新題目，即使 MVP 已達成
- 題目內容從「必需」逐漸轉向「補充」
- 當時間耗盡，自動進入階段三

---

## 📋 玩家操作指南

### 在階段二中，玩家可以：

✅ **快速回答**：盡可能多地填寫虛擬節點資訊

✅ **部分填寫**：每次只填一個欄位（姓名、性別、生日）

✅ **跳過問題**：選擇「跳過」將題目重新排隊

✅ **標記不知道**：選擇「不知道」表示無法確認

✅ **修正答案**：最後確認前可修改（全部提交後無法修改）

❌ **不能看族譜**：無法查看族譜的完整結構（保持神秘感）

❌ **不能搶答**：無法回答他人獨佔的任務（鎖定機制保護）

❌ **不能修改已提交的答案**：提交後無法回溯
