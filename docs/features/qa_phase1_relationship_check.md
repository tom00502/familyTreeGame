# 階段 1：關係確認 (Relationship Check)

## 📌 階段概述

**目標**：確立玩家之間的親屬關係，建立族譜骨架

**玩家體驗**：持續回答「其他玩家是你的誰」的問題，系統通過二階段追問機制確認具體關係

**系統目標**：根據確認的關係自動生成虛擬節點，為下一階段的資料填充指明方向

---

## 🎯 二階段追問機制

### 第一階段：選擇方向

系統先詢問玩家該人屬於哪個方向的親戚：

```
「玩家 B 是在你的：
  □ 爸爸那邊的人（父系親戚）
  □ 媽媽那邊的人（母系親戚）
  □ 配偶那邊的人
  □ 子女那邊的人
  □ 完全不知道」
```

#### 各方向定義

- **爸爸那邊的人**：從父親開始向上或橫向的所有親戚（爺爺、奶奶、伯父、叔叔、姑姑、堂兄弟姊妹等）
- **媽媽那邊的人**：從母親開始向上或橫向的所有親戚（奶奶、外公、舅舅、阿姨、表兄弟姊妹等）
- **配偶那邊的人**：配偶本人
- **子女那邊的人**：自己的後代（兒子、女兒、孫子、孫女等）

### 第二階段：選擇具體稱謂

根據第一階段選擇的方向，系統顯示該方向內的所有親屬稱謂供選擇。

#### 各方向的稱謂範圍（四等親內）

**父系方向**：

- 直系：爸爸、爺爺、曾祖父
- 旁系：伯父、叔叔、姑姑
- 同輩：哥哥、弟弟、姊姊、妹妹
- 侄輩：堂兄弟、堂姐妹、堂侄子、堂甥女

**母系方向**：

- 直系：媽媽、奶奶、曾祖母
- 旁系：舅舅、阿姨
- 同輩：哥哥、弟弟、姊姊、妹妹
- 侄輩：表兄弟、表姐妹、表侄子、表甥女

**配偶系**：

- 配偶（丈夫/妻子）

**子女系**：

- 直系：兒子、女兒、孫子、孫女、曾孫子、曾孫女

---

## 🔍 性別過濾規則

系統根據被詢問者的性別在第二階段自動過濾不符合的稱謂選項：

- **被詢問者為男性**：過濾掉女性專屬稱謂（媽媽、女兒、姑姑、阿姨等）
- **被詢問者為女性**：過濾掉男性專屬稱謝（爸爸、兒子、伯父、叔叔、舅舅等）

**前提條件**：玩家必須在遊戲開始時填寫性別（必填項），系統不處理未指定性別的情況

---

## 📝 特殊情況處理

### 「完全不知道」的處理流程

當玩家在第一階段選擇「完全不知道」時（表示不知道該人屬於父系/母系/配偶/子女的任何方向）：

**處理方式**：

- 系統**不進行**第二階段具體稱謂追問
- 將此玩家間的關係記錄為「待確認」狀態
- 不對此關係做任何假設或預填

**後續處理**：

- 等待其他玩家提供的資訊來推斷兩人之間的關係
- 在階段二（資料補齊）中，其他玩家填寫相關虛擬節點時可能會補齊此資訊
- 若最終仍無法確定，該玩家可能形成獨立的族譜分支

**異常情況**：

- 若所有玩家之間都互相「完全不知道」，系統正常進入階段二
- 階段二只詢問與各玩家本身直接相關的虛擬節點（父母、祖父母等）
- 最終族譜可能包含多個**不相交的樹狀結構**
- 此為正常情況，系統不視為錯誤，無需特殊提示

### 「不知道」的追問流程

當玩家選擇「不知道」具體稱謝時，系統進行**額外追問**以幫助第二階段建立方向：

```
「那麼，玩家 B 是在你的：
  □ 爸爸那邊的人（父系親戚）
  □ 媽媽那邊的人（母系親戚）
  □ 配偶那邊的人
  □ 子女那邊的人
  □ 完全不知道」
```

**追問的作用**：

- 即使玩家不知道具體稱謂，至少能確定族譜該朝哪個方向延伸
- 幫助系統建立虛擬節點的基本骨架
- 為第二階段資料補齊提供方向指引

---

## 📊 出題派發規則

### 玩家人數與派題策略

#### 情況 1：玩家少於 4 人

**直接配對法則**：每位玩家詢問**所有其他玩家**的關係

```
示例（三人遊戲：A、B、C）
- A 被詢問：B 是你的誰？C 是你的誰？（2 個問題）
- B 被詢問：A 是你的誰？C 是你的誰？（2 個問題）
- C 被詢問：A 是你的誰？B 是你的誰？（2 個問題）
```

**計算**：n 人遊戲共 n × (n - 1) 個問題（每人 n - 1 個）

#### 情況 2：玩家 4 人或以上

**均衡分配法則**：每位玩家詢問**3 位其他玩家**的關係，確保所有玩家被詢問次數均勻分布

```
示例（五人遊戲：A、B、C、D、E）
- A 被詢問：B、C、D（3 個問題）
- B 被詢問：A、C、E（3 個問題）
- C 被詢問：A、D、E（3 個問題）
- D 被詢問：B、C、E（3 個問題）
- E 被詢問：A、B、D（3 個問題）
```

**派題演算法目標**：

- ✓ 每位玩家都被詢問 3 個其他玩家
- ✓ 所有玩家被詢問關係的次數盡可能均勻分布
- ✓ 若玩家數量 n 時無法完全均勻，差異控制在 ±1

**計算**：n 人遊戲共 3n 個問題

### 派題執行方式

| 維度           | 規則           | 說明                                     |
| -------------- | -------------- | ---------------------------------------- |
| 玩家連線狀態   | 僅派給活躍玩家 | 離線玩家暫不派題                         |
| 玩家身份       | 排除旁觀者     | 只有參與遊戲的玩家收到題目               |
| 同時派題數     | 全體玩家同時   | 所有活躍玩家同時接收自己的關係詢問       |
| 階段一完成條件 | 並行等待       | 所有玩家完成所有派題問題後一起進入階段二 |

### 階段一完成判定

**完成條件**：

- 每位玩家最多被詢問 3 個其他玩家（玩家 < 4 時為所有其他玩家）
- 每個問題包含第一階段（選擇方向）和可能的第二階段（選擇具體稱謝）
- 所有玩家完成所有第一階段問題（方向選擇）後，系統統一進入階段二

**不需等待的情況**：

- 不需等待玩家完成「完全不知道」的額外確認步驟
- 玩家可選擇「跳過」問題，該問題自動延後（進入待回答池）
- 即使有未回答問題也不阻塞進度，系統自動進入階段二

---

## 🔄 虛擬節點自動生成邏輯

根據玩家間的關係回答，系統在後台自動生成虛擬節點，為第二階段資料補齊指明方向。

### 生成範例

**例 1：父子關係**

```
玩家 A 回答「玩家 B 是我的兒子」
└─ 自動生成虛擬節點需求：
   ├─ 需要填寫虛擬節點「A 的配偶（B 的母親）」
   └─ 方向：向下擴張
```

**例 2：堂兄關係**

```
玩家 A 回答「玩家 B 是我的堂兄」
└─ 自動生成虛擬節點需求：
   ├─ 需要填寫虛擬節點「A 的父親」、「A 的祖父」
   ├─ 需要填寫虛擬節點「A 的伯父/叔叔」（祖父的其他子女）
   └─ 方向：向上追溯，再向下延伸
```

**例 3：完全不知道 + 再追問**

```
玩家 A 回答「不知道玩家 B」，但再追問時選擇「B 是我媽媽那邊的人」
└─ 自動生成虛擬節點需求：
   ├─ 需要在「母系方向」填寫虛擬節點（從母親開始）
   └─ 方向標記：母系，具體關係待定
```

**例 4：配偶確認誘發新生成**

```
玩家 A 與玩家 B 是夫妻，玩家 C 回答「B 是我的媽媽」
├─ 已確認：A ↔ B (配偶)，C → B (母)
└─ 自動生成虛擬節點需求：
   ├─ 需要確認 A 是否為 C 的父親
   ├─ 需要填寫 C 的配偶（A 的女婿/媳婦）
   └─ 方向：配偶系和子女系生成
```

### 關鍵規則

- **階段一只確認直接關係**：階段一不會在此階段自動生成具體虛擬節點
- **關係確認結果指導方向**：關係確認結果會在第二階段指導虛擬節點的填寫方向與優先級
- **為第二階段準備數據**：階段一完成後，系統已知道需要在何方向填寫哪些虛擬節點，進入「資料補齊階段」

---

## 💾 資料結構

### 關係記錄格式

```json
{
  "relationshipId": "unique-id",
  "fromPlayerId": "A",
  "toPlayerId": "B",
  "status": "confirmed|pending|unknown",
  "direction": "paternal|maternal|spouse|children|unknown",
  "kinship": "father|mother|son|daughter|uncle|aunt|cousin|...",
  "confirmedAt": "timestamp"
}
```

### 狀態定義

- **confirmed**：玩家完整回答了兩階段問題
- **pending**：玩家回答了第一階段（方向）但可能缺少第二階段（具體稱謝）
- **unknown**：玩家選擇「完全不知道」，待日後推導

---

## 📋 玩家操作指南

### 在階段一中，玩家可以：

✅ **回答問題**：選擇「爸爸那邊」等方向，再選擇具體稱謝

✅ **不確定時追問**：若選擇「不知道」具體稱謝，系統會追問方向

✅ **跳過問題**：選擇「跳過」將問題延後處理（進入待回答池）

✅ **標記不知道**：選擇「完全不知道」表示完全無法確定關係

❌ **不能看族譜**：無法查看族譜的完整結構（保持神秘感）

❌ **不能修改答案**：提交後無法回溯修改（但可在階段二通過其他方式補正）
