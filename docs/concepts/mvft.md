# 最小可行族譜 (MVFT - Minimum Viable Family Tree)

## 概述

**最小可行族譜 (MVFT)** 是一套具備**「橫向寬度」但限制「旁系深度」**的族譜動態生長邏輯，確保核心家庭成員資訊完整，同時防止非必要資料的無限發散。

### 快速導航

- **只想了解概念？** → 閱讀本文檔
- **準備實作程式碼？** → 參考 [technical/mvft.md](../technical/mvft.md)
- **如何驗證實作？** → 見本文檔「開發時的常見錯誤」與 [technical/mvft.md](../technical/mvft.md) 的測試建議

---

## 核心術語定義

### 關鍵路徑 (Key Path)

連結任意兩位參與玩家（Players）之間的邏輯血緣路徑。

**範例**：

```
玩家 A（姪女）→ 父親 → 祖父母 ← 玩家 B（姑姑）
```

使用圖論演算法（BFS/DFS）尋找最短路徑。

### 關鍵節點 (Key Node)

位於關鍵路徑上的所有節點，包含：

- 起始玩家 (Player A)
- 終點玩家 (Player B)
- 共同祖先 (Common Ancestor)
- 路徑中間的所有直系節點

**數據結構特徵**：關鍵節點在程式碼中通常用以下屬性來標識（實作細節請見 [technical/mvft.md](../technical/mvft.md)）：

- `id` - 唯一識別碼
- `name` / `gender` - 身份信息
- `isPlayer` - 是否為玩家節點
- `isKeyNode` - 是否為關鍵路徑上的節點
- `expansionType: "FULL"` - 關鍵節點必須標記為完整擴張

### 核心家庭單元 (Essential Family Unit, EFU)

**EFU 是一個節點的完整性定義**。一個節點的 EFU 完整，意味著該節點具備以下三個維度的完整資料：

| 維度         | 定義           | 說明                         |
| ------------ | -------------- | ---------------------------- |
| **垂直向上** | 父、母記錄完整 | 必須有父親與母親的基本信息   |
| **水平向側** | 配偶記錄完整   | 必須有配偶信息（已婚情況下） |
| **垂直向下** | 子女記錄完整   | 必須有所有子女的完整列表     |

**關鍵特性**：

- EFU 完整 ≠ 其關係對象也完整
  - 例：玩家 A 的 EFU 完整 = A 有父母、配偶、子女資料
  - 但父親的 EFU 是否完整不影響 A 的 EFU 完整度
- 終端節點（TERMINAL）不需檢查 EFU 完整
  - 終端節點只需姓名、性別

**簡化範例**：

```
玩家 A（關鍵節點）
├─ 父親 ✅（已記錄）
├─ 母親 ✅（已記錄）
├─ 配偶 ✅（已記錄）
└─ 子女 ✅（已記錄）
   ├─ 兒子（終端節點）
   └─ 女兒（終端節點）
```

玩家 A 的 EFU 完整：✅ 父✅ 母✅ 配偶✅ 子女✅

### 完整擴張 (Full Expansion)

針對關鍵節點執行三個維度的資料填充：

| 維度     | 動作         | 範例             |
| -------- | ------------ | ---------------- |
| **向上** | 確認父、母   | 玩家的父親、母親 |
| **橫向** | 確認配偶     | 玩家的丈夫/妻子  |
| **向下** | 確認所有子女 | 玩家的所有孩子   |

**適用對象**：所有關鍵節點 ✅

**規則**：

- 必須確認 EFU 中的所有成員
- 必須確認所有手足
- 所有信息必須完整

### 終端擴張 (Terminal Expansion)

僅填寫「姓名」與「性別」，不進行任何維度的延伸追蹤。

**適用對象**：為滿足「手足補全」而產生的、不在關鍵路徑上的節點

**關鍵限制**：

- ✅ **僅收集基本信息** - 名字、性別

---

## MVFT 判定原則

### 原則：關鍵節點的 EFU 完整化

**MVFT 完整 = 所有關鍵節點的 EFU 都完整**

對於每一個關鍵節點，需檢查三個維度（程式碼實作見 [technical/mvft.md](../technical/mvft.md)）：

**1️⃣ 向上検查（父母維度）**

- ✅ 節點必須有父親記錄
- ✅ 節點必須有母親記錄
- ❌ 但祖父、祖母不是必検查對象（他們是父親的葉子）

**2️⃣ 向侧検查（配偶維度）**

- ✅ 節點必須有配偶記錄（如已婚）
- ❌ 但配偶的父母、配偶的子女不是必検查對象

**3️⃣ 向下検查（子女維度）**

- ✅ 節點必須有所有子女的完整記錄
- ❌ 但這些子女是否有各自的父母、配偶、子女不是必検查對象

**驗證邏輯（簡化版）：**

```
EFU 完整 = (有父親) AND (有母親) AND (有配偶 或 未婚) AND (有所有子女)
```

### 原則二：非關鍵路徑之終端限制

為滿足「手足補全」而產生的、**不在關鍵路徑上**的手足節點 → 定義為**終端節點**

**終端節點規則**：程式中應實作以下檢查機制（詳見 [technical/mvft.md](../technical/mvft.md)）：

- 若 `node NOT in keyPath` 且 `node.expansionType === TERMINAL`
  - ✅ 可僅記錄姓名、性別

---

## 實作範例

### 範例：玩家 A 的 EFU 評估

假設以玩家 A（已婚，有兩個子女）為關鍵節點，評估其 EFU 完整性：

| 維度 | 檢查項目         | A 的狀態    | 是否完整 |
| ---- | ---------------- | ----------- | -------- |
| 向上 | A 有父親記錄     | 已填寫      | 是       |
| 向上 | A 有母親記錄     | 已填寫      | 是       |
| 向側 | A 有配偶記錄     | 已認識配偶  | 是       |
| 向下 | A 有所有子女記錄 | 已知有 2 人 | 是       |

**EFU 完整性**：A 的 EFU 已完整

### 重要提示：關鍵路徑上的其他節點

若 A 的父親或配偶或其子女尚未完整，不會影響 A 本身的 EFU 狀態。

- A 的父親尚未知道祖父、祖母 → 不影響 A 的 EFU 評估（向上已完整）
- A 的配偶尚未認識自己的父母 → 不影響 A 的 EFU 評估（向側已完整）
- A 的子女尚未認識他們各自的配偶 → 不影響 A 的 EFU 評估（向下已完整）

### 達成 MVFT 的條件

當所有關鍵節點的 EFU 都達到完整狀態時，就達成了 MVFT。

---

## 任務派發優先級

資料填充任務應遵循以下優先級順序：

### Level 1：路徑閉合 🔴

**目標**：確保關鍵路徑的垂直完整性

**任務內容**：

- 確認關鍵節點的父親
- 確認關鍵節點的母親
- 補全共同祖先

**優先理由**：只有路徑完整，才能建立 A 與 B 的血緣關係

### Level 2：橫向補齊 🟡

**目標**：完成 EFU 的橫向完整性

**任務內容**：

- 補全關鍵節點的配偶
- 補全關鍵節點的所有手足

**優先理由**：家庭單元與兄弟姐妹關係對視覺呈現很重要

### Level 3：屬性填充 🟢

**目標**：補全細節資訊

**任務內容**：

- 生日、年紀
- 其他選填屬性

**優先理由**：這些是「錦上添花」，不影響族譜骨架

---

## 常見實作模式

MVFT 的核心實作包含以下幾個模式（具體程式碼實作見 [technical/mvft.md](../technical/mvft.md)）：

### 模式 1：節點屬性標記

每個族譜節點需具備以下屬性：

- **身份信息**：姓名、性別、出生日期
- **MVFT 標記**：`isPlayer`、`isOnKeyPath`、`expansionType`
- **關係連結**：父、母、配偶、子女

詳細的資料結構定義見 [technical/mvft.md](../technical/mvft.md)。

### 模式 2：擴張策略判斷

在決定是否詢問節點的親屬資訊時，應根據以下邏輯：

- 若節點在**關鍵路徑上** → 採用**完整擴張** (FULL)
- 若節點**不在關鍵路徑上** → 採用**終端擴張** (TERMINAL)

具體判斷實作見 [technical/mvft.md](../technical/mvft.md)。

### 模式 3：數據驗證

定期驗證 MVFT 的完整性，檢查以下項目：

- 所有關鍵節點是否都有父、母記錄
- 所有手足是否都被找到
- EFU 中的配偶與子女是否完整

詳見 [technical/mvft.md](../technical/mvft.md) 的驗證函式。

---

## 開發時的常見錯誤

實作 MVFT 時需特別注意以下常見陷阱（程式碼修正範例見 [technical/mvft.md](../technical/mvft.md)）：

### ❌ 錯誤 1：對終端節點進行擴張

**問題**：詢問終端節點的配偶或子女資訊

**正確做法**：終端節點僅收集姓名與性別，不進行任何維度的延伸追蹤

### ❌ 錯誤 2：未正確標記關鍵路徑

**問題**：路徑中遺漏中間節點（如直接跳過某位祖先）

**正確做法**：必須包含起點、終點及所有中間節點，確保路徑連續

### ❌ 錯誤 3：手足補全不完整

**問題**：只記錄已知的子女，忽略未被主動提及的手足

**正確做法**：必須從父、母的角度查詢完整的子女列表，不能遺漏任何手足

### ❌ 錯誤 4：過度擴展非關鍵節點

**問題**：對所有節點都進行完整擴張，導致終端限制失效

**正確做法**：只對關鍵路徑上的節點進行完整擴張，其他節點採用終端擴張

### ❌ 錯誤 5：忽視 EFU 完整性

**問題**：家庭單元中缺少某些成員（如遺漏某個子女或配偶）

**正確做法**：每個 EFU 必須確保所有成員都被記錄，特別是所有子女

---

## 測試建議

MVFT 實作應通過以下測試驗證（具體測試程式碼見 [technical/mvft.md](../technical/mvft.md)）：

**關鍵節點擴張測試**：

- ✅ 關鍵節點必須有完整的父、母記錄
- ✅ 關鍵節點的配偶關係必須完整（如已婚）
- ✅ 關鍵節點的手足必須全部找到

**終端節點限制測試**：

- ✅ 終端節點不應詢問配偶
- ✅ 終端節點不應詢問子女
- ✅ 終端節點應只包含基本屬性（姓名、性別）

**路徑與任務測試**：

- ✅ 關鍵路徑必須正確連結兩位玩家
- ✅ 路徑中不應有間隙（相鄰節點必須有血緣連結）
- ✅ 任務應按優先級正確排序（Level 1 → Level 2 → Level 3）

**完整性驗證**：

- ✅ 完整的 MVFT 應通過全面驗證
- ✅ 不完整的 MVFT 應被正確標記
- ✅ EFU 必須包含所有子女（無遺漏）

---

## 核心設計原則總結

### ✅ MVFT 確保的事項

- 每一位核心家庭成員在視覺呈現時不會缺席
- 關鍵路徑上的節點資訊完整
- 手足關係完整呈現（滿足 EFU 定義）
- 族譜呈現有完整的橫向寬度

### ❌ MVFT 防止的事項

- 非必要資料的無限發散
- 旁系親屬（表親、遠親）的過度擴展
- 資料填充任務的失控成長
- 過深的代際追溯

---

## 相關文件

**概念與規格**：

- 資料填充策略（業務層）：[qa_phase2_data_filling.md](../features/qa_phase2_data_filling.md)
- 結果計分與驗證（業務層）：[qa_phase3_data_check.md](../features/qa_phase3_data_check.md)
- 房間管理與資料結構（管理層）：[room_management.md](../management/room_management.md)

**技術實作**：

- MVFT 技術實作指南（程式碼詳解）：[technical/mvft.md](../technical/mvft.md)

---

## 使用本文件的建議

- **首次閱讀**：了解 MVFT 的核心概念、術語定義與設計原則
- **實作階段**：參考本文件的概念說明與常見錯誤列表
- **編寫程式碼**：查看 [technical/mvft.md](../technical/mvft.md) 獲取實作細節與程式碼示例
- **測試驗證**：按照本文件的測試建議與 [technical/mvft.md](../technical/mvft.md) 的測試程式碼進行驗證

---

**文件版本**：1.0  
**最後更新**：2026-02-24  
**維護者**：Family Tree Game Project
